{"ast":null,"code":"var _jsxFileName = \"/Users/ankurporwal/Documents/AIConsultation/Frontend/src/components/chat/ChatPanel.tsx\",\n  _s = $RefreshSig$();\nimport { useEffect, useRef, useState } from \"react\";\nimport { jsxDEV as _jsxDEV } from \"react/jsx-dev-runtime\";\nfunction makeId(prefix = \"m\") {\n  return `${prefix}${Date.now()}${Math.floor(Math.random() * 1000)}`;\n}\nexport default function ChatPanel({\n  activeThread,\n  session,\n  preferences\n}) {\n  _s();\n  var _activeThread$title;\n  const API_BASE = typeof window !== \"undefined\" && window.API_BASE || process.env.REACT_APP_API_BASE || \"http://localhost:8000\";\n  const DEBUG = false;\n  const [input, setInput] = useState(\"\");\n  const [suggestions, setSuggestions] = useState([]);\n  const [messages, setMessages] = useState([]);\n  const [userMessageCount, setUserMessageCount] = useState(0);\n  const [showSignupModal, setShowSignupModal] = useState(false);\n  const [signupName, setSignupName] = useState(\"\");\n  const [signupEmail, setSignupEmail] = useState(\"\");\n  const [sending, setSending] = useState(false);\n  const abortRef = useRef(null);\n  const inputRef = useRef(null);\n\n  // Ensure a user_id exists (anonymous) so messages can be stored server-side\n  useEffect(() => {\n    const existing = localStorage.getItem(\"user_id\");\n    if (!existing) {\n      const anon = `anon_${Date.now()}`;\n      localStorage.setItem(\"user_id\", anon);\n      localStorage.setItem(\"ai_user_msg_count\", \"0\");\n      setUserMessageCount(0);\n    } else {\n      const cnt = Number(localStorage.getItem(\"ai_user_msg_count\") || \"0\") || 0;\n      setUserMessageCount(cnt);\n    }\n  }, []);\n\n  // listen for suggestion updates from RightPanel\n  useEffect(() => {\n    function handler(e) {\n      try {\n        var _e$detail;\n        const arr = ((e === null || e === void 0 ? void 0 : (_e$detail = e.detail) === null || _e$detail === void 0 ? void 0 : _e$detail.suggestions) || []).map(s => String(s).trim()).filter(Boolean);\n        setSuggestions(arr);\n      } catch (err) {\n        // ignore\n      }\n    }\n    window.addEventListener(\"ai_suggestions\", handler);\n    return () => window.removeEventListener(\"ai_suggestions\", handler);\n  }, []);\n  useEffect(() => {\n    if (session !== null && session !== void 0 && session.messages && Array.isArray(session.messages)) {\n      const mapped = session.messages.map(m => {\n        var _m$role, _ref, _m$content, _m$created_at;\n        return {\n          id: m.entry_id ? String(m.entry_id) : makeId(\"s\"),\n          role: (_m$role = m.role) !== null && _m$role !== void 0 ? _m$role : m.source === \"assistant\" ? \"assistant\" : \"user\",\n          content: (_ref = (_m$content = m.content) !== null && _m$content !== void 0 ? _m$content : m.text) !== null && _ref !== void 0 ? _ref : \"\",\n          created_at: (_m$created_at = m.created_at) !== null && _m$created_at !== void 0 ? _m$created_at : undefined\n        };\n      });\n      setMessages(mapped);\n    } else {\n      setMessages([]);\n    }\n  }, [session]);\n  function updateMessage(id, patch) {\n    setMessages(prev => prev.map(m => m.id === id ? {\n      ...m,\n      ...patch\n    } : m));\n  }\n  function pushMessage(msg) {\n    setMessages(prev => [...prev, msg]);\n  }\n  function pushDebug(_entry) {\n    // debug disabled — no-op to preserve call sites\n    if (DEBUG) console.debug(\"DEBUG_LOG:\", _entry);\n  }\n\n  // legacy debug setter (no-op) kept so existing code that calls setRawReply doesn't break\n  const setRawReply = _ => {};\n  async function handleSend() {\n    var _activeThread$thread_;\n    const text = input.trim();\n    if (!text || sending) return;\n    pushDebug(`handleSend invoked — text length ${text.length}`);\n    const userMsg = {\n      id: makeId(\"u\"),\n      role: \"user\",\n      content: text,\n      created_at: new Date().toISOString()\n    };\n    pushMessage(userMsg);\n    setInput(\"\");\n    const userId = localStorage.getItem(\"user_id\") || \"u1\";\n    const threadId = (_activeThread$thread_ = activeThread === null || activeThread === void 0 ? void 0 : activeThread.thread_id) !== null && _activeThread$thread_ !== void 0 ? _activeThread$thread_ : \"t1\";\n    try {\n      const userPayload = {\n        user_id: userId,\n        thread_id: threadId,\n        role: \"user\",\n        content: text\n      };\n      if (DEBUG) console.debug(\"POST /message (user):\", userPayload);\n      pushDebug(`POST /message (user) -> ${API_BASE}/message`);\n      void fetch(`${API_BASE}/message`, {\n        method: \"POST\",\n        headers: {\n          \"Content-Type\": \"application/json\"\n        },\n        body: JSON.stringify(userPayload)\n      });\n    } catch (e) {\n      pushDebug(`POST /message (user) failed: ${String(e)}`);\n    }\n\n    // increment anonymous user message count and persist\n    try {\n      const prev = Number(localStorage.getItem(\"ai_user_msg_count\") || \"0\") || 0;\n      const next = prev + 1;\n      localStorage.setItem(\"ai_user_msg_count\", String(next));\n      setUserMessageCount(next);\n      // after 5 user messages, prompt signup/login\n      if (next >= 5) {\n        setShowSignupModal(true);\n      }\n    } catch (e) {}\n    const assistantId = makeId(\"a\");\n    const assistantPlaceholder = {\n      id: assistantId,\n      role: \"assistant\",\n      content: \"\",\n      created_at: new Date().toISOString(),\n      streaming: true\n    };\n    pushMessage(assistantPlaceholder);\n    if (abortRef.current) abortRef.current.abort();\n    const ac = new AbortController();\n    abortRef.current = ac;\n    setSending(true);\n    let finalAssistantContent = \"\";\n    try {\n      const res = await fetch(`${API_BASE}/chat?stream=true`, {\n        method: \"POST\",\n        headers: {\n          \"Content-Type\": \"application/json\",\n          Accept: \"text/event-stream\"\n        },\n        body: JSON.stringify({\n          user_id: userId,\n          thread_id: threadId,\n          message: text\n        }),\n        signal: ac.signal\n      });\n      pushDebug(`/chat response status: ${res.status} content-type=${res.headers.get(\"content-type\")}`);\n      if (!res.ok) {\n        let fallbackText = `Assistant error (${res.status})`;\n        try {\n          var _ref2, _json$reply;\n          const json = await res.json();\n          fallbackText = (_ref2 = (_json$reply = json === null || json === void 0 ? void 0 : json.reply) !== null && _json$reply !== void 0 ? _json$reply : json === null || json === void 0 ? void 0 : json.message) !== null && _ref2 !== void 0 ? _ref2 : fallbackText;\n        } catch (e) {\n          // ignore\n        }\n        const fallback = getFakeResponse(text, preferences) + `\\n\\n(${fallbackText})`;\n        updateMessage(assistantId, {\n          content: fallback,\n          streaming: false\n        });\n        setRawReply(fallback);\n        pushDebug(`/chat non-ok -> ${res.status} fallback set`);\n        return;\n      }\n      const contentType = (res.headers.get(\"content-type\") || \"\").toLowerCase();\n      pushDebug(`/chat content-type resolved: ${contentType}`);\n      if (contentType.includes(\"text/event-stream\")) {\n        // stream as SSE\n        const reader = res.body.getReader();\n        const decoder = new TextDecoder();\n        let sseBuffer = \"\";\n        let accumulated = \"\";\n        let done = false;\n        while (!done) {\n          const {\n            value,\n            done: d\n          } = await reader.read();\n          if (d) {\n            done = true;\n            pushDebug(\"stream reader signalled done\");\n          }\n          if (value) {\n            const chunkStr = decoder.decode(value, {\n              stream: true\n            });\n            pushDebug(`stream chunk len ${chunkStr.length}`);\n            sseBuffer += chunkStr;\n            let sepIndex;\n            while ((sepIndex = sseBuffer.indexOf(\"\\n\\n\")) !== -1) {\n              const rawEvent = sseBuffer.slice(0, sepIndex);\n              sseBuffer = sseBuffer.slice(sepIndex + 2);\n              const lines = rawEvent.split(/\\r?\\n/);\n              for (const line of lines) {\n                const trimmed = line.trim();\n                if (!trimmed) continue;\n                if (trimmed.startsWith(\"data:\")) {\n                  const payload = trimmed.slice(5).trim();\n                  if (payload === \"[DONE]\") {\n                    done = true;\n                    break;\n                  }\n                  try {\n                    var _obj$delta;\n                    const obj = JSON.parse(payload);\n                    const delta = (_obj$delta = obj === null || obj === void 0 ? void 0 : obj.delta) !== null && _obj$delta !== void 0 ? _obj$delta : \"\";\n                    if (delta) {\n                      accumulated += delta;\n                      pushDebug(`delta appended len ${delta.length}`);\n                      updateMessage(assistantId, {\n                        content: accumulated,\n                        streaming: true\n                      });\n                    }\n                  } catch (e) {\n                    accumulated += payload;\n                    pushDebug(`raw payload appended len ${payload.length}`);\n                    updateMessage(assistantId, {\n                      content: accumulated,\n                      streaming: true\n                    });\n                  }\n                }\n              }\n            }\n          }\n        }\n        pushDebug(`stream finished total length ${accumulated.length}`);\n        updateMessage(assistantId, {\n          content: accumulated,\n          streaming: false\n        });\n        finalAssistantContent = accumulated;\n        setRawReply(accumulated);\n      } else {\n        var _ref3, _data$reply;\n        // non-streaming (JSON) response\n        const data = await res.json();\n        const reply = (_ref3 = (_data$reply = data === null || data === void 0 ? void 0 : data.reply) !== null && _data$reply !== void 0 ? _data$reply : data === null || data === void 0 ? void 0 : data.message) !== null && _ref3 !== void 0 ? _ref3 : getFakeResponse(text, preferences);\n        updateMessage(assistantId, {\n          content: reply,\n          streaming: false\n        });\n        finalAssistantContent = reply;\n        setRawReply(typeof reply === \"string\" ? reply : JSON.stringify(reply));\n        pushDebug(`/chat non-stream reply length ${String(finalAssistantContent).length}`);\n      }\n      try {\n        var _ref4, _finalAssistantConten, _messages$find;\n        const assistantPayload = {\n          user_id: userId,\n          thread_id: threadId,\n          role: \"assistant\",\n          content: (_ref4 = (_finalAssistantConten = finalAssistantContent) !== null && _finalAssistantConten !== void 0 ? _finalAssistantConten : (_messages$find = messages.find(m => m.id === assistantId)) === null || _messages$find === void 0 ? void 0 : _messages$find.content) !== null && _ref4 !== void 0 ? _ref4 : \"\"\n        };\n        pushDebug(`POST /message (assistant) -> ${API_BASE}/message (content len ${String(assistantPayload.content).length})`);\n        void fetch(`${API_BASE}/message`, {\n          method: \"POST\",\n          headers: {\n            \"Content-Type\": \"application/json\"\n          },\n          body: JSON.stringify(assistantPayload)\n        });\n      } catch (e) {\n        pushDebug(`POST /message (assistant) failed: ${String(e)}`);\n      }\n    } catch (err) {\n      if ((err === null || err === void 0 ? void 0 : err.name) === \"AbortError\") {\n        updateMessage(assistantId, {\n          content: \"(stream aborted)\",\n          streaming: false\n        });\n        pushDebug(\"stream aborted (AbortError)\");\n      } else {\n        const fallback = getFakeResponse(text, preferences) + \" (offline fallback)\";\n        updateMessage(assistantId, {\n          content: fallback,\n          streaming: false\n        });\n        finalAssistantContent = fallback;\n        setRawReply(fallback);\n        pushDebug(`handleSend error: ${String(err)}`);\n      }\n    } finally {\n      setSending(false);\n      abortRef.current = null;\n    }\n  }\n  return /*#__PURE__*/_jsxDEV(\"div\", {\n    className: \"chat-panel\",\n    children: [/*#__PURE__*/_jsxDEV(\"div\", {\n      className: \"chat-header\",\n      children: /*#__PURE__*/_jsxDEV(\"h3\", {\n        children: (_activeThread$title = activeThread === null || activeThread === void 0 ? void 0 : activeThread.title) !== null && _activeThread$title !== void 0 ? _activeThread$title : \"Thinking space\"\n      }, void 0, false, {\n        fileName: _jsxFileName,\n        lineNumber: 267,\n        columnNumber: 9\n      }, this)\n    }, void 0, false, {\n      fileName: _jsxFileName,\n      lineNumber: 266,\n      columnNumber: 7\n    }, this), /*#__PURE__*/_jsxDEV(\"div\", {\n      className: \"messages\",\n      \"aria-live\": \"polite\",\n      children: messages.map(m => /*#__PURE__*/_jsxDEV(\"div\", {\n        className: `msg ${m.role}`,\n        children: [/*#__PURE__*/_jsxDEV(\"div\", {\n          className: \"msg-meta\",\n          style: {\n            fontSize: 12,\n            color: \"#666\"\n          },\n          children: [m.role, m.created_at ? ` • ${new Date(m.created_at).toLocaleTimeString()}` : \"\"]\n        }, void 0, true, {\n          fileName: _jsxFileName,\n          lineNumber: 273,\n          columnNumber: 13\n        }, this), /*#__PURE__*/_jsxDEV(\"pre\", {\n          style: {\n            whiteSpace: \"pre-wrap\",\n            margin: 0\n          },\n          children: m.content\n        }, void 0, false, {\n          fileName: _jsxFileName,\n          lineNumber: 277,\n          columnNumber: 13\n        }, this), m.streaming && /*#__PURE__*/_jsxDEV(\"div\", {\n          style: {\n            fontSize: 12,\n            color: \"#666\"\n          },\n          children: \"Streaming\\u2026\"\n        }, void 0, false, {\n          fileName: _jsxFileName,\n          lineNumber: 278,\n          columnNumber: 29\n        }, this)]\n      }, m.id, true, {\n        fileName: _jsxFileName,\n        lineNumber: 272,\n        columnNumber: 11\n      }, this))\n    }, void 0, false, {\n      fileName: _jsxFileName,\n      lineNumber: 270,\n      columnNumber: 7\n    }, this), /*#__PURE__*/_jsxDEV(\"div\", {\n      className: \"chat-input\",\n      style: {\n        display: \"flex\",\n        gap: 8,\n        marginTop: 8,\n        alignItems: 'flex-start'\n      },\n      children: [/*#__PURE__*/_jsxDEV(\"textarea\", {\n        id: \"chat-input\",\n        name: \"chat_input\",\n        \"aria-label\": \"Chat input\",\n        value: input,\n        placeholder: \"Let's untangle this\",\n        ref: inputRef,\n        onChange: e => setInput(e.target.value),\n        onKeyDown: e => {\n          if (e.key === \"Enter\" && !e.shiftKey) {\n            e.preventDefault();\n            handleSend();\n          }\n        },\n        style: {\n          flex: 1,\n          minHeight: 80\n        }\n      }, void 0, false, {\n        fileName: _jsxFileName,\n        lineNumber: 284,\n        columnNumber: 9\n      }, this), /*#__PURE__*/_jsxDEV(\"div\", {\n        style: {\n          display: \"flex\",\n          flexDirection: \"column\",\n          gap: 8\n        },\n        children: [/*#__PURE__*/_jsxDEV(\"button\", {\n          onClick: handleSend,\n          disabled: sending || !input.trim() || userMessageCount >= 5,\n          style: {\n            minWidth: 100\n          },\n          children: sending ? \"Sending…\" : \"Send\"\n        }, void 0, false, {\n          fileName: _jsxFileName,\n          lineNumber: 301,\n          columnNumber: 13\n        }, this), /*#__PURE__*/_jsxDEV(\"button\", {\n          onClick: () => {\n            if (abortRef.current) abortRef.current.abort();\n          },\n          disabled: !abortRef.current,\n          style: {\n            minWidth: 100\n          },\n          children: \"Cancel\"\n        }, void 0, false, {\n          fileName: _jsxFileName,\n          lineNumber: 304,\n          columnNumber: 11\n        }, this)]\n      }, void 0, true, {\n        fileName: _jsxFileName,\n        lineNumber: 300,\n        columnNumber: 9\n      }, this)]\n    }, void 0, true, {\n      fileName: _jsxFileName,\n      lineNumber: 283,\n      columnNumber: 7\n    }, this), showSignupModal && /*#__PURE__*/_jsxDEV(\"div\", {\n      style: {\n        position: 'fixed',\n        left: 0,\n        right: 0,\n        top: 0,\n        bottom: 0,\n        background: 'rgba(0,0,0,0.4)',\n        display: 'flex',\n        alignItems: 'center',\n        justifyContent: 'center'\n      },\n      children: /*#__PURE__*/_jsxDEV(\"div\", {\n        style: {\n          background: '#fff',\n          padding: 20,\n          borderRadius: 8,\n          width: 420\n        },\n        children: [/*#__PURE__*/_jsxDEV(\"h3\", {\n          children: \"Welcome \\u2014 create an account to save your work\"\n        }, void 0, false, {\n          fileName: _jsxFileName,\n          lineNumber: 320,\n          columnNumber: 13\n        }, this), /*#__PURE__*/_jsxDEV(\"p\", {\n          children: \"You can chat up to 5 messages before creating an account. Create an account to keep your threads and summaries across devices.\"\n        }, void 0, false, {\n          fileName: _jsxFileName,\n          lineNumber: 321,\n          columnNumber: 13\n        }, this), /*#__PURE__*/_jsxDEV(\"div\", {\n          style: {\n            display: 'flex',\n            flexDirection: 'column',\n            gap: 8\n          },\n          children: [/*#__PURE__*/_jsxDEV(\"input\", {\n            placeholder: \"Name\",\n            value: signupName,\n            onChange: e => setSignupName(e.target.value)\n          }, void 0, false, {\n            fileName: _jsxFileName,\n            lineNumber: 323,\n            columnNumber: 15\n          }, this), /*#__PURE__*/_jsxDEV(\"input\", {\n            placeholder: \"Email\",\n            value: signupEmail,\n            onChange: e => setSignupEmail(e.target.value)\n          }, void 0, false, {\n            fileName: _jsxFileName,\n            lineNumber: 324,\n            columnNumber: 15\n          }, this), /*#__PURE__*/_jsxDEV(\"div\", {\n            style: {\n              display: 'flex',\n              gap: 8,\n              marginTop: 8\n            },\n            children: [/*#__PURE__*/_jsxDEV(\"button\", {\n              className: \"prompt-btn\",\n              onClick: async () => {\n                // create account\n                try {\n                  const res = await fetch(`${API_BASE}/users/create`, {\n                    method: 'POST',\n                    headers: {\n                      'Content-Type': 'application/json'\n                    },\n                    body: JSON.stringify({\n                      name: signupName,\n                      email: signupEmail\n                    })\n                  });\n                  if (!res.ok) {\n                    const txt = await res.text().catch(() => '');\n                    alert('Signup failed: ' + res.status + ' ' + txt);\n                    return;\n                  }\n                  const data = await res.json();\n                  const newUser = data.user;\n                  if (newUser && newUser.user_id) {\n                    localStorage.setItem('user_id', newUser.user_id);\n                    localStorage.setItem('ai_user_msg_count', '0');\n                    setUserMessageCount(0);\n                    setShowSignupModal(false);\n                    alert('Account created. Your user id: ' + newUser.user_id);\n                  }\n                } catch (e) {\n                  alert('Signup failed: ' + String(e));\n                }\n              },\n              children: \"Create account\"\n            }, void 0, false, {\n              fileName: _jsxFileName,\n              lineNumber: 326,\n              columnNumber: 17\n            }, this), /*#__PURE__*/_jsxDEV(\"button\", {\n              className: \"prompt-btn\",\n              onClick: () => {\n                localStorage.setItem('ai_user_msg_count', '0');\n                setUserMessageCount(0);\n                setShowSignupModal(false);\n              },\n              children: \"Continue as guest\"\n            }, void 0, false, {\n              fileName: _jsxFileName,\n              lineNumber: 346,\n              columnNumber: 17\n            }, this)]\n          }, void 0, true, {\n            fileName: _jsxFileName,\n            lineNumber: 325,\n            columnNumber: 15\n          }, this)]\n        }, void 0, true, {\n          fileName: _jsxFileName,\n          lineNumber: 322,\n          columnNumber: 13\n        }, this)]\n      }, void 0, true, {\n        fileName: _jsxFileName,\n        lineNumber: 319,\n        columnNumber: 11\n      }, this)\n    }, void 0, false, {\n      fileName: _jsxFileName,\n      lineNumber: 318,\n      columnNumber: 9\n    }, this), suggestions && suggestions.length > 0 && /*#__PURE__*/_jsxDEV(\"div\", {\n      style: {\n        marginTop: 8,\n        display: 'flex',\n        gap: 8,\n        flexWrap: 'wrap'\n      },\n      children: suggestions.map((s, i) => /*#__PURE__*/_jsxDEV(\"button\", {\n        className: \"suggestion-chip\",\n        onClick: () => {\n          // insert suggestion at the current caret position (or append) and focus\n          const area = inputRef.current;\n          if (!area) {\n            setInput(s);\n          } else {\n            var _area$selectionStart, _area$selectionEnd;\n            const start = (_area$selectionStart = area.selectionStart) !== null && _area$selectionStart !== void 0 ? _area$selectionStart : area.value.length;\n            const end = (_area$selectionEnd = area.selectionEnd) !== null && _area$selectionEnd !== void 0 ? _area$selectionEnd : start;\n            const before = area.value.slice(0, start);\n            const after = area.value.slice(end);\n            const nextVal = (before + s + after).trimStart();\n            setInput(nextVal);\n            // set caret right after inserted suggestion\n            setTimeout(() => {\n              area.focus();\n              const caret = (before + s).length;\n              area.setSelectionRange(caret, caret);\n            }, 0);\n          }\n        },\n        style: {\n          padding: '6px 10px',\n          borderRadius: 6\n        },\n        children: s\n      }, i, false, {\n        fileName: _jsxFileName,\n        lineNumber: 357,\n        columnNumber: 13\n      }, this))\n    }, void 0, false, {\n      fileName: _jsxFileName,\n      lineNumber: 355,\n      columnNumber: 9\n    }, this), /*#__PURE__*/_jsxDEV(\"div\", {\n      style: {\n        marginTop: 8\n      },\n      children: /*#__PURE__*/_jsxDEV(\"button\", {\n        className: \"prompt-btn\",\n        onClick: async () => {\n          if (!activeThread) return;\n          if (!window.confirm(\"Delete this chat history for the selected thread?\")) return;\n          const userId = localStorage.getItem(\"user_id\") || \"u1\";\n          try {\n            const resp = await fetch(`${API_BASE}/messages/${encodeURIComponent(userId)}/${encodeURIComponent(activeThread.thread_id)}`, {\n              method: \"DELETE\",\n              headers: {\n                \"Content-Type\": \"application/json\"\n              }\n            });\n            if (!resp.ok) {\n              const body = await resp.text().catch(() => \"\");\n              alert(\"Failed to delete chat: \" + resp.status + \" \" + body);\n              return;\n            }\n            setMessages([]);\n            alert(\"Chat history deleted.\");\n          } catch (e) {\n            alert(\"Delete failed: \" + String(e));\n          }\n        },\n        children: \"Delete Chat\"\n      }, void 0, false, {\n        fileName: _jsxFileName,\n        lineNumber: 391,\n        columnNumber: 9\n      }, this)\n    }, void 0, false, {\n      fileName: _jsxFileName,\n      lineNumber: 390,\n      columnNumber: 7\n    }, this)]\n  }, void 0, true, {\n    fileName: _jsxFileName,\n    lineNumber: 265,\n    columnNumber: 5\n  }, this);\n}\n_s(ChatPanel, \"FENgqvmQTO9xnAiLFCisbhDF1bs=\");\n_c = ChatPanel;\nfunction getFakeResponse(input, preferences) {\n  if (!preferences) return \"I’m here to listen.\";\n  if (preferences.default_tone === \"direct\") {\n    return \"Let’s simplify this. What decision are you actually trying to make?\";\n  }\n  if (preferences.depth_level === \"deep\") {\n    return \"Let me reflect this back. It sounds like you’re torn between safety and growth. What’s driving that tension right now?\";\n  }\n  return \"I’m hearing a few competing thoughts here. Want to slow down and look at them one by one?\";\n}\nvar _c;\n$RefreshReg$(_c, \"ChatPanel\");","map":{"version":3,"names":["useEffect","useRef","useState","jsxDEV","_jsxDEV","makeId","prefix","Date","now","Math","floor","random","ChatPanel","activeThread","session","preferences","_s","_activeThread$title","API_BASE","window","process","env","REACT_APP_API_BASE","DEBUG","input","setInput","suggestions","setSuggestions","messages","setMessages","userMessageCount","setUserMessageCount","showSignupModal","setShowSignupModal","signupName","setSignupName","signupEmail","setSignupEmail","sending","setSending","abortRef","inputRef","existing","localStorage","getItem","anon","setItem","cnt","Number","handler","e","_e$detail","arr","detail","map","s","String","trim","filter","Boolean","err","addEventListener","removeEventListener","Array","isArray","mapped","m","_m$role","_ref","_m$content","_m$created_at","id","entry_id","role","source","content","text","created_at","undefined","updateMessage","patch","prev","pushMessage","msg","pushDebug","_entry","console","debug","setRawReply","_","handleSend","_activeThread$thread_","length","userMsg","toISOString","userId","threadId","thread_id","userPayload","user_id","fetch","method","headers","body","JSON","stringify","next","assistantId","assistantPlaceholder","streaming","current","abort","ac","AbortController","finalAssistantContent","res","Accept","message","signal","status","get","ok","fallbackText","_ref2","_json$reply","json","reply","fallback","getFakeResponse","contentType","toLowerCase","includes","reader","getReader","decoder","TextDecoder","sseBuffer","accumulated","done","value","d","read","chunkStr","decode","stream","sepIndex","indexOf","rawEvent","slice","lines","split","line","trimmed","startsWith","payload","_obj$delta","obj","parse","delta","_ref3","_data$reply","data","_ref4","_finalAssistantConten","_messages$find","assistantPayload","find","name","className","children","title","fileName","_jsxFileName","lineNumber","columnNumber","style","fontSize","color","toLocaleTimeString","whiteSpace","margin","display","gap","marginTop","alignItems","placeholder","ref","onChange","target","onKeyDown","key","shiftKey","preventDefault","flex","minHeight","flexDirection","onClick","disabled","minWidth","position","left","right","top","bottom","background","justifyContent","padding","borderRadius","width","email","txt","catch","alert","newUser","user","flexWrap","i","area","_area$selectionStart","_area$selectionEnd","start","selectionStart","end","selectionEnd","before","after","nextVal","trimStart","setTimeout","focus","caret","setSelectionRange","confirm","resp","encodeURIComponent","_c","default_tone","depth_level","$RefreshReg$"],"sources":["/Users/ankurporwal/Documents/AIConsultation/Frontend/src/components/chat/ChatPanel.tsx"],"sourcesContent":["import { Thread, Session, UserPreferences } from \"../../types/thinking\";\nimport { useEffect, useRef, useState } from \"react\";\n\ninterface ChatPanelProps {\n  activeThread?: Thread | null;\n  session?: Session | null;\n  preferences: UserPreferences;\n}\n\ntype Message = {\n  id: string;\n  role: \"user\" | \"assistant\" | \"system\";\n  content: string;\n  created_at?: string;\n  streaming?: boolean;\n};\n\nfunction makeId(prefix = \"m\") {\n  return `${prefix}${Date.now()}${Math.floor(Math.random() * 1000)}`;\n}\n\nexport default function ChatPanel({ activeThread, session, preferences }: ChatPanelProps) {\n  const API_BASE = (typeof window !== \"undefined\" && (window as any).API_BASE) || (process.env.REACT_APP_API_BASE as string) || \"http://localhost:8000\";\n  const DEBUG = false;\n\n  const [input, setInput] = useState(\"\");\n  const [suggestions, setSuggestions] = useState<string[]>([]);\n  const [messages, setMessages] = useState<Message[]>([]);\n  const [userMessageCount, setUserMessageCount] = useState<number>(0);\n  const [showSignupModal, setShowSignupModal] = useState<boolean>(false);\n  const [signupName, setSignupName] = useState<string>(\"\");\n  const [signupEmail, setSignupEmail] = useState<string>(\"\");\n  const [sending, setSending] = useState(false);\n  const abortRef = useRef<AbortController | null>(null);\n  const inputRef = useRef<HTMLTextAreaElement | null>(null);\n\n  // Ensure a user_id exists (anonymous) so messages can be stored server-side\n  useEffect(() => {\n    const existing = localStorage.getItem(\"user_id\");\n    if (!existing) {\n      const anon = `anon_${Date.now()}`;\n      localStorage.setItem(\"user_id\", anon);\n      localStorage.setItem(\"ai_user_msg_count\", \"0\");\n      setUserMessageCount(0);\n    } else {\n      const cnt = Number(localStorage.getItem(\"ai_user_msg_count\") || \"0\") || 0;\n      setUserMessageCount(cnt);\n    }\n  }, []);\n\n  // listen for suggestion updates from RightPanel\n  useEffect(() => {\n    function handler(e: any) {\n      try {\n        const arr = (e?.detail?.suggestions || []).map((s: any) => String(s).trim()).filter(Boolean);\n        setSuggestions(arr);\n      } catch (err) {\n        // ignore\n      }\n    }\n    window.addEventListener(\"ai_suggestions\", handler as EventListener);\n    return () => window.removeEventListener(\"ai_suggestions\", handler as EventListener);\n  }, []);\n\n  useEffect(() => {\n    if (session?.messages && Array.isArray(session.messages)) {\n      const mapped = session.messages.map((m: any) => ({\n        id: m.entry_id ? String(m.entry_id) : makeId(\"s\"),\n        role: m.role ?? (m.source === \"assistant\" ? \"assistant\" : \"user\"),\n        content: m.content ?? m.text ?? \"\",\n        created_at: m.created_at ?? undefined,\n      }));\n      setMessages(mapped);\n    } else {\n      setMessages([]);\n    }\n  }, [session]);\n\n  function updateMessage(id: string, patch: Partial<Message>) {\n    setMessages((prev) => prev.map((m) => (m.id === id ? { ...m, ...patch } : m)));\n  }\n\n  function pushMessage(msg: Message) {\n    setMessages((prev) => [...prev, msg]);\n  }\n\n  function pushDebug(_entry: string) {\n    // debug disabled — no-op to preserve call sites\n    if (DEBUG) console.debug(\"DEBUG_LOG:\", _entry);\n  }\n\n  // legacy debug setter (no-op) kept so existing code that calls setRawReply doesn't break\n  const setRawReply = (_: any) => {};\n\n  async function handleSend() {\n    const text = input.trim();\n    if (!text || sending) return;\n\n    pushDebug(`handleSend invoked — text length ${text.length}`);\n\n    const userMsg: Message = { id: makeId(\"u\"), role: \"user\", content: text, created_at: new Date().toISOString() };\n    pushMessage(userMsg);\n    setInput(\"\");\n\n    const userId = localStorage.getItem(\"user_id\") || \"u1\";\n    const threadId = activeThread?.thread_id ?? \"t1\";\n\n    try {\n      const userPayload = { user_id: userId, thread_id: threadId, role: \"user\", content: text };\n      if (DEBUG) console.debug(\"POST /message (user):\", userPayload);\n      pushDebug(`POST /message (user) -> ${API_BASE}/message`);\n      void fetch(`${API_BASE}/message`, {\n        method: \"POST\",\n        headers: { \"Content-Type\": \"application/json\" },\n        body: JSON.stringify(userPayload),\n      });\n    } catch (e) {\n      pushDebug(`POST /message (user) failed: ${String(e)}`);\n    }\n\n      // increment anonymous user message count and persist\n      try {\n        const prev = Number(localStorage.getItem(\"ai_user_msg_count\") || \"0\") || 0;\n        const next = prev + 1;\n        localStorage.setItem(\"ai_user_msg_count\", String(next));\n        setUserMessageCount(next);\n        // after 5 user messages, prompt signup/login\n        if (next >= 5) {\n          setShowSignupModal(true);\n        }\n      } catch (e) {}\n\n    const assistantId = makeId(\"a\");\n    const assistantPlaceholder: Message = { id: assistantId, role: \"assistant\", content: \"\", created_at: new Date().toISOString(), streaming: true };\n    pushMessage(assistantPlaceholder);\n\n    if (abortRef.current) abortRef.current.abort();\n    const ac = new AbortController();\n    abortRef.current = ac;\n\n    setSending(true);\n    let finalAssistantContent = \"\";\n    try {\n      const res = await fetch(`${API_BASE}/chat?stream=true`, {\n        method: \"POST\",\n        headers: { \"Content-Type\": \"application/json\", Accept: \"text/event-stream\" },\n        body: JSON.stringify({ user_id: userId, thread_id: threadId, message: text }),\n        signal: ac.signal,\n      });\n\n      pushDebug(`/chat response status: ${res.status} content-type=${res.headers.get(\"content-type\")}`);\n\n      if (!res.ok) {\n        let fallbackText = `Assistant error (${res.status})`;\n        try {\n          const json = await res.json();\n          fallbackText = json?.reply ?? json?.message ?? fallbackText;\n        } catch (e) {\n          // ignore\n        }\n        const fallback = getFakeResponse(text, preferences) + `\\n\\n(${fallbackText})`;\n        updateMessage(assistantId, { content: fallback, streaming: false });\n        setRawReply(fallback);\n        pushDebug(`/chat non-ok -> ${res.status} fallback set`);\n        return;\n      }\n\n      const contentType = (res.headers.get(\"content-type\") || \"\").toLowerCase();\n      pushDebug(`/chat content-type resolved: ${contentType}`);\n\n      if (contentType.includes(\"text/event-stream\")) {\n        // stream as SSE\n        const reader = res.body.getReader();\n        const decoder = new TextDecoder();\n        let sseBuffer = \"\";\n        let accumulated = \"\";\n        let done = false;\n        while (!done) {\n          const { value, done: d } = await reader.read();\n          if (d) {\n            done = true;\n            pushDebug(\"stream reader signalled done\");\n          }\n          if (value) {\n            const chunkStr = decoder.decode(value, { stream: true });\n            pushDebug(`stream chunk len ${chunkStr.length}`);\n            sseBuffer += chunkStr;\n\n            let sepIndex;\n            while ((sepIndex = sseBuffer.indexOf(\"\\n\\n\")) !== -1) {\n              const rawEvent = sseBuffer.slice(0, sepIndex);\n              sseBuffer = sseBuffer.slice(sepIndex + 2);\n\n              const lines = rawEvent.split(/\\r?\\n/);\n              for (const line of lines) {\n                const trimmed = line.trim();\n                if (!trimmed) continue;\n                if (trimmed.startsWith(\"data:\")) {\n                  const payload = trimmed.slice(5).trim();\n                  if (payload === \"[DONE]\") {\n                    done = true;\n                    break;\n                  }\n                  try {\n                    const obj = JSON.parse(payload);\n                    const delta = obj?.delta ?? \"\";\n                    if (delta) {\n                      accumulated += delta;\n                      pushDebug(`delta appended len ${delta.length}`);\n                      updateMessage(assistantId, { content: accumulated, streaming: true });\n                    }\n                  } catch (e) {\n                    accumulated += payload;\n                    pushDebug(`raw payload appended len ${payload.length}`);\n                    updateMessage(assistantId, { content: accumulated, streaming: true });\n                  }\n                }\n              }\n            }\n          }\n        }\n        pushDebug(`stream finished total length ${accumulated.length}`);\n        updateMessage(assistantId, { content: accumulated, streaming: false });\n        finalAssistantContent = accumulated;\n        setRawReply(accumulated);\n      } else {\n        // non-streaming (JSON) response\n        const data = await res.json();\n        const reply = data?.reply ?? data?.message ?? getFakeResponse(text, preferences);\n        updateMessage(assistantId, { content: reply, streaming: false });\n        finalAssistantContent = reply;\n        setRawReply(typeof reply === \"string\" ? reply : JSON.stringify(reply));\n        pushDebug(`/chat non-stream reply length ${String(finalAssistantContent).length}`);\n      }\n\n      try {\n        const assistantPayload = { user_id: userId, thread_id: threadId, role: \"assistant\", content: finalAssistantContent ?? messages.find((m) => m.id === assistantId)?.content ?? \"\" };\n        pushDebug(`POST /message (assistant) -> ${API_BASE}/message (content len ${String(assistantPayload.content).length})`);\n        void fetch(`${API_BASE}/message`, {\n          method: \"POST\",\n          headers: { \"Content-Type\": \"application/json\" },\n          body: JSON.stringify(assistantPayload),\n        });\n      } catch (e) {\n        pushDebug(`POST /message (assistant) failed: ${String(e)}`);\n      }\n    } catch (err: any) {\n      if (err?.name === \"AbortError\") {\n        updateMessage(assistantId, { content: \"(stream aborted)\", streaming: false });\n        pushDebug(\"stream aborted (AbortError)\");\n      } else {\n        const fallback = getFakeResponse(text, preferences) + \" (offline fallback)\";\n        updateMessage(assistantId, { content: fallback, streaming: false });\n        finalAssistantContent = fallback;\n        setRawReply(fallback);\n        pushDebug(`handleSend error: ${String(err)}`);\n      }\n    } finally {\n      setSending(false);\n      abortRef.current = null;\n    }\n  }\n\n  return (\n    <div className=\"chat-panel\">\n      <div className=\"chat-header\">\n        <h3>{activeThread?.title ?? \"Thinking space\"}</h3>\n      </div>\n\n      <div className=\"messages\" aria-live=\"polite\">\n        {messages.map((m) => (\n          <div key={m.id} className={`msg ${m.role}`}>\n            <div className=\"msg-meta\" style={{ fontSize: 12, color: \"#666\" }}>\n              {m.role}\n              {m.created_at ? ` • ${new Date(m.created_at).toLocaleTimeString()}` : \"\"}\n            </div>\n            <pre style={{ whiteSpace: \"pre-wrap\", margin: 0 }}>{m.content}</pre>\n            {m.streaming && <div style={{ fontSize: 12, color: \"#666\" }}>Streaming…</div>}\n          </div>\n        ))}\n      </div>\n\n      <div className=\"chat-input\" style={{ display: \"flex\", gap: 8, marginTop: 8, alignItems: 'flex-start' }}>\n        <textarea\n          id=\"chat-input\"\n          name=\"chat_input\"\n          aria-label=\"Chat input\"\n          value={input}\n          placeholder=\"Let's untangle this\"\n          ref={inputRef}\n          onChange={(e) => setInput(e.target.value)}\n          onKeyDown={(e) => {\n            if (e.key === \"Enter\" && !e.shiftKey) {\n              e.preventDefault();\n              handleSend();\n            }\n          }}\n          style={{ flex: 1, minHeight: 80 }}\n        />\n        <div style={{ display: \"flex\", flexDirection: \"column\", gap: 8 }}>\n            <button onClick={handleSend} disabled={sending || !input.trim() || userMessageCount >= 5} style={{ minWidth: 100 }}>\n              {sending ? \"Sending…\" : \"Send\"}\n            </button>\n          <button\n            onClick={() => {\n              if (abortRef.current) abortRef.current.abort();\n            }}\n            disabled={!abortRef.current}\n            style={{ minWidth: 100 }}\n          >\n            Cancel\n          </button>\n        </div>\n      </div>\n\n      {/* Signup modal shown after anonymous user reaches limit */}\n      {showSignupModal && (\n        <div style={{ position: 'fixed', left: 0, right: 0, top: 0, bottom: 0, background: 'rgba(0,0,0,0.4)', display: 'flex', alignItems: 'center', justifyContent: 'center' }}>\n          <div style={{ background: '#fff', padding: 20, borderRadius: 8, width: 420 }}>\n            <h3>Welcome — create an account to save your work</h3>\n            <p>You can chat up to 5 messages before creating an account. Create an account to keep your threads and summaries across devices.</p>\n            <div style={{ display: 'flex', flexDirection: 'column', gap: 8 }}>\n              <input placeholder=\"Name\" value={signupName} onChange={(e) => setSignupName(e.target.value)} />\n              <input placeholder=\"Email\" value={signupEmail} onChange={(e) => setSignupEmail(e.target.value)} />\n              <div style={{ display: 'flex', gap: 8, marginTop: 8 }}>\n                <button className=\"prompt-btn\" onClick={async () => {\n                  // create account\n                  try {\n                    const res = await fetch(`${API_BASE}/users/create`, { method: 'POST', headers: { 'Content-Type': 'application/json' }, body: JSON.stringify({ name: signupName, email: signupEmail }) });\n                    if (!res.ok) {\n                      const txt = await res.text().catch(() => '');\n                      alert('Signup failed: ' + res.status + ' ' + txt);\n                      return;\n                    }\n                    const data = await res.json();\n                    const newUser = data.user;\n                    if (newUser && newUser.user_id) {\n                      localStorage.setItem('user_id', newUser.user_id);\n                      localStorage.setItem('ai_user_msg_count', '0');\n                      setUserMessageCount(0);\n                      setShowSignupModal(false);\n                      alert('Account created. Your user id: ' + newUser.user_id);\n                    }\n                  } catch (e) { alert('Signup failed: ' + String(e)); }\n                }}>Create account</button>\n                <button className=\"prompt-btn\" onClick={() => { localStorage.setItem('ai_user_msg_count', '0'); setUserMessageCount(0); setShowSignupModal(false); }}>Continue as guest</button>\n              </div>\n            </div>\n          </div>\n        </div>\n      )}\n\n      {/* Suggestion bar populated from RightPanel summary processing */}\n      {suggestions && suggestions.length > 0 && (\n        <div style={{ marginTop: 8, display: 'flex', gap: 8, flexWrap: 'wrap' }}>\n          {suggestions.map((s, i) => (\n            <button\n              key={i}\n              className=\"suggestion-chip\"\n              onClick={() => {\n                  // insert suggestion at the current caret position (or append) and focus\n                  const area = inputRef.current;\n                  if (!area) {\n                    setInput(s);\n                  } else {\n                    const start = area.selectionStart ?? area.value.length;\n                    const end = area.selectionEnd ?? start;\n                    const before = area.value.slice(0, start);\n                    const after = area.value.slice(end);\n                    const nextVal = (before + s + after).trimStart();\n                    setInput(nextVal);\n                    // set caret right after inserted suggestion\n                    setTimeout(() => {\n                      area.focus();\n                      const caret = (before + s).length;\n                      area.setSelectionRange(caret, caret);\n                    }, 0);\n                  }\n                }}\n              style={{ padding: '6px 10px', borderRadius: 6 }}\n            >\n              {s}\n            </button>\n          ))}\n        </div>\n      )}\n\n      {/* debug UI removed */}\n\n      <div style={{ marginTop: 8 }}>\n        <button\n          className=\"prompt-btn\"\n          onClick={async () => {\n            if (!activeThread) return;\n            if (!window.confirm(\"Delete this chat history for the selected thread?\")) return;\n            const userId = localStorage.getItem(\"user_id\") || \"u1\";\n            try {\n              const resp = await fetch(`${API_BASE}/messages/${encodeURIComponent(userId)}/${encodeURIComponent(activeThread.thread_id)}`, {\n                method: \"DELETE\",\n                headers: { \"Content-Type\": \"application/json\" },\n              });\n              if (!resp.ok) {\n                const body = await resp.text().catch(() => \"\");\n                alert(\"Failed to delete chat: \" + resp.status + \" \" + body);\n                return;\n              }\n              setMessages([]);\n              alert(\"Chat history deleted.\");\n            } catch (e) {\n              alert(\"Delete failed: \" + String(e));\n            }\n          }}\n        >\n          Delete Chat\n        </button>\n      </div>\n    </div>\n  );\n}\n\nfunction getFakeResponse(input: string, preferences?: UserPreferences): string {\n  if (!preferences) return \"I’m here to listen.\";\n  if ((preferences as any).default_tone === \"direct\") {\n    return \"Let’s simplify this. What decision are you actually trying to make?\";\n  }\n  if ((preferences as any).depth_level === \"deep\") {\n    return \"Let me reflect this back. It sounds like you’re torn between safety and growth. What’s driving that tension right now?\";\n  }\n  return \"I’m hearing a few competing thoughts here. Want to slow down and look at them one by one?\";\n}\n\n"],"mappings":"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","ignoreList":[]},"metadata":{},"sourceType":"module","externalDependencies":[]}