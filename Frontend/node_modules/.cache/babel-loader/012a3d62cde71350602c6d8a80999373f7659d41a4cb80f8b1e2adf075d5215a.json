{"ast":null,"code":"var _jsxFileName = \"/Users/ankurporwal/Documents/PersonalManagementAgent/Frontend/src/components/chat/ChatPanel.tsx\",\n  _s = $RefreshSig$();\nimport { useEffect, useRef, useState } from \"react\";\nimport { createPortal } from 'react-dom';\nimport { jsxDEV as _jsxDEV } from \"react/jsx-dev-runtime\";\nfunction makeId(prefix = \"m\") {\n  return `${prefix}${Date.now()}${Math.floor(Math.random() * 1000)}`;\n}\nexport default function ChatPanel({\n  activeThread,\n  session,\n  preferences,\n  onOpenRight,\n  showSignupModal: propShowSignupModal,\n  setShowSignupModal: propSetShowSignupModal,\n  onlyShowModal: propOnlyShowModal,\n  onBack\n}) {\n  _s();\n  var _activeThread$title;\n  const API_BASE = typeof window !== \"undefined\" && window.API_BASE || process.env.REACT_APP_API_BASE || \"http://localhost:8000\";\n  const DEBUG = false;\n  const getAuthHeader = () => {\n    try {\n      const t = localStorage.getItem('auth_token_fallback') || localStorage.getItem('token');\n      return t ? {\n        Authorization: `Bearer ${t}`\n      } : {};\n    } catch (e) {\n      return {};\n    }\n  };\n  const [input, setInput] = useState(\"\");\n  const [suggestions, setSuggestions] = useState([]);\n  const [messages, setMessages] = useState([]);\n  const [userMessageCount, setUserMessageCount] = useState(0);\n  const [welcomeShown, setWelcomeShown] = useState(false);\n  const welcomeButtonRef = useRef(null);\n  const [showSignupModal, setShowSignupModal] = useState(false);\n  // signupName / signupEmail removed: not used in UI (lint cleanup)\n  const [authMode, setAuthMode] = useState('create');\n  const [loginEmail, setLoginEmail] = useState(\"\");\n  const [loginPassword, setLoginPassword] = useState(\"\");\n  const [createName, setCreateName] = useState(\"\");\n  const [createEmail, setCreateEmail] = useState(\"\");\n  const [createPassword, setCreatePassword] = useState(\"\");\n  const [createBirthYear, setCreateBirthYear] = useState(\"\");\n  const [authLoading, setAuthLoading] = useState(false);\n  const [hideModeToggle, setHideModeToggle] = useState(false);\n  const [sending, setSending] = useState(false);\n  const abortRef = useRef(null);\n  const inputRef = useRef(null);\n  const messagesRef = useRef(null);\n  const modalRef = useRef(null);\n  const firstInputRef = useRef(null);\n  const prevFocusedRef = useRef(null);\n\n  // Ensure a user_id exists (anonymous) so messages can be stored server-side\n  useEffect(() => {\n    const existing = localStorage.getItem(\"user_id\");\n    if (!existing) {\n      const anon = `anon_${Date.now()}`;\n      localStorage.setItem(\"user_id\", anon);\n      localStorage.setItem(\"ai_user_msg_count\", \"0\");\n      setUserMessageCount(0);\n    } else {\n      const cnt = Number(localStorage.getItem(\"ai_user_msg_count\") || \"0\") || 0;\n      setUserMessageCount(cnt);\n    }\n    try {\n      const shown = localStorage.getItem('ai_welcome_shown');\n      setWelcomeShown(Boolean(shown));\n    } catch (e) {}\n  }, []);\n\n  // Focus the welcome dismiss button when banner is shown for accessibility\n  useEffect(() => {\n    try {\n      const uid = typeof window !== 'undefined' ? localStorage.getItem('user_id') : null;\n      const isAnon = !!uid && uid.startsWith('anon_');\n      const isNewUser = isAnon && messages.length === 0 && userMessageCount === 0;\n      if (!welcomeShown && isNewUser) {\n        setTimeout(() => {\n          try {\n            var _welcomeButtonRef$cur;\n            (_welcomeButtonRef$cur = welcomeButtonRef.current) === null || _welcomeButtonRef$cur === void 0 ? void 0 : _welcomeButtonRef$cur.focus();\n          } catch (e) {}\n        }, 50);\n      }\n    } catch (e) {}\n    // eslint-disable-next-line react-hooks/exhaustive-deps\n  }, [welcomeShown, messages.length, userMessageCount]);\n\n  // listen for suggestion updates from RightPanel\n  useEffect(() => {\n    function handler(e) {\n      try {\n        var _e$detail;\n        const arr = ((e === null || e === void 0 ? void 0 : (_e$detail = e.detail) === null || _e$detail === void 0 ? void 0 : _e$detail.suggestions) || []).map(s => String(s).trim()).filter(Boolean);\n        setSuggestions(arr);\n      } catch (err) {\n        // ignore\n      }\n    }\n    window.addEventListener(\"ai_suggestions\", handler);\n    return () => window.removeEventListener(\"ai_suggestions\", handler);\n  }, []);\n\n  // If the page-level controller passed modal props, prefer those; otherwise\n  // use internal state. Also listen for `open_signup_modal_hint` which carries\n  // a short-lived mode hint from the page when it mounts ChatPanel.\n  const modalOpen = typeof propShowSignupModal === 'boolean' ? propShowSignupModal : showSignupModal;\n  const setModalOpen = propSetShowSignupModal || setShowSignupModal;\n  const onlyShowModal = typeof propOnlyShowModal === 'boolean' ? propOnlyShowModal : false;\n  useEffect(() => {\n    function hintHandler(e) {\n      try {\n        var _e$detail2;\n        const mode = e === null || e === void 0 ? void 0 : (_e$detail2 = e.detail) === null || _e$detail2 === void 0 ? void 0 : _e$detail2.mode;\n        if (mode === 'login' || mode === 'create') {\n          setAuthMode(mode);\n          setHideModeToggle(true);\n        }\n        setModalOpen(true);\n      } catch (err) {}\n    }\n    window.addEventListener('open_signup_modal_hint', hintHandler);\n    return () => window.removeEventListener('open_signup_modal_hint', hintHandler);\n  }, [setModalOpen]);\n\n  // Manage focus when modal opens/closes (accessibility)\n  useEffect(() => {\n    if (modalOpen) {\n      try {\n        prevFocusedRef.current = document.activeElement;\n        setTimeout(() => {\n          // focus the first relevant input depending on mode\n          if (firstInputRef.current) {\n            firstInputRef.current.focus();\n          } else if (modalRef.current) {\n            modalRef.current.focus();\n          }\n        }, 0);\n      } catch (e) {}\n    } else {\n      // restore focus\n      try {\n        var _prevFocusedRef$curre;\n        (_prevFocusedRef$curre = prevFocusedRef.current) === null || _prevFocusedRef$curre === void 0 ? void 0 : _prevFocusedRef$curre.focus();\n      } catch (e) {}\n    }\n  }, [modalOpen]);\n\n  // basic focus trap: keep tab inside modal\n  function onModalKeyDown(e) {\n    if (e.key !== 'Tab') return;\n    const container = modalRef.current;\n    if (!container) return;\n    const focusable = container.querySelectorAll(\"a[href], button:not([disabled]), textarea, input, select, [tabindex]:not([tabindex='-1'])\");\n    if (!focusable || focusable.length === 0) return;\n    const first = focusable[0];\n    const last = focusable[focusable.length - 1];\n    if (!e.shiftKey && document.activeElement === last) {\n      e.preventDefault();\n      first.focus();\n    }\n    if (e.shiftKey && document.activeElement === first) {\n      e.preventDefault();\n      last.focus();\n    }\n  }\n\n  // For anonymous / new users with no messages, show thread-specific starter suggestions\n  useEffect(() => {\n    try {\n      const uid = typeof window !== \"undefined\" ? localStorage.getItem('user_id') : null;\n      if (!uid || !uid.startsWith('anon_')) return; // only for anonymous new users\n    } catch (e) {\n      return;\n    }\n    if (!activeThread) return;\n    if (messages.length > 0) return; // user already has messages\n    if (suggestions && suggestions.length > 0) return; // don't override existing suggestions\n\n    const starterByThread = {\n      t1: [\"I'm thinking about changing roles but unsure which direction feels right.\"],\n      t2: [\"I keep ruminating at night and can't fall asleep.\"]\n    };\n    const defaults = starterByThread[activeThread.thread_id] || [];\n    if (defaults.length) setSuggestions(defaults);\n  }, [activeThread, messages, suggestions]);\n  useEffect(() => {\n    if (session !== null && session !== void 0 && session.messages && Array.isArray(session.messages)) {\n      const mapped = session.messages.map(m => {\n        var _m$role, _ref, _m$content, _m$created_at;\n        return {\n          id: m.entry_id ? String(m.entry_id) : makeId(\"s\"),\n          role: (_m$role = m.role) !== null && _m$role !== void 0 ? _m$role : m.source === \"assistant\" ? \"assistant\" : \"user\",\n          content: (_ref = (_m$content = m.content) !== null && _m$content !== void 0 ? _m$content : m.text) !== null && _ref !== void 0 ? _ref : \"\",\n          created_at: (_m$created_at = m.created_at) !== null && _m$created_at !== void 0 ? _m$created_at : undefined\n        };\n      });\n      setMessages(mapped);\n    } else {\n      setMessages([]);\n    }\n  }, [session]);\n\n  // auto-scroll to bottom when messages change\n  useEffect(() => {\n    try {\n      const el = messagesRef.current;\n      if (el) {\n        el.scrollTop = el.scrollHeight;\n      }\n    } catch (e) {}\n  }, [messages]);\n  function updateMessage(id, patch) {\n    setMessages(prev => prev.map(m => m.id === id ? {\n      ...m,\n      ...patch\n    } : m));\n  }\n  function pushMessage(msg) {\n    setMessages(prev => [...prev, msg]);\n  }\n  function pushDebug(_entry) {\n    // debug disabled — no-op to preserve call sites\n    if (DEBUG) console.debug(\"DEBUG_LOG:\", _entry);\n  }\n\n  // legacy debug setter (no-op) kept so existing code that calls setRawReply doesn't break\n  const setRawReply = _ => {};\n  async function handleSend() {\n    var _activeThread$thread_;\n    const text = input.trim();\n    if (!text || sending) return;\n    pushDebug(`handleSend invoked — text length ${text.length}`);\n    const userMsg = {\n      id: makeId(\"u\"),\n      role: \"user\",\n      content: text,\n      created_at: new Date().toISOString()\n    };\n    pushMessage(userMsg);\n    setInput(\"\");\n    const userId = localStorage.getItem(\"user_id\") || \"u1\";\n    const threadId = (_activeThread$thread_ = activeThread === null || activeThread === void 0 ? void 0 : activeThread.thread_id) !== null && _activeThread$thread_ !== void 0 ? _activeThread$thread_ : \"t1\";\n    try {\n      const userPayload = {\n        user_id: userId,\n        thread_id: threadId,\n        role: \"user\",\n        content: text\n      };\n      if (DEBUG) console.debug(\"POST /message (user):\", userPayload);\n      pushDebug(`POST /message (user) -> ${API_BASE}/message`);\n      try {\n        const headers = {\n          \"Content-Type\": \"application/json\",\n          ...getAuthHeader()\n        };\n        void fetch(`${API_BASE}/message`, {\n          method: \"POST\",\n          headers,\n          credentials: 'include',\n          body: JSON.stringify(userPayload)\n        });\n      } catch (e) {}\n    } catch (e) {\n      pushDebug(`POST /message (user) failed: ${String(e)}`);\n    }\n\n    // increment anonymous user message count and persist\n    try {\n      const prev = Number(localStorage.getItem(\"ai_user_msg_count\") || \"0\") || 0;\n      const next = prev + 1;\n      localStorage.setItem(\"ai_user_msg_count\", String(next));\n      setUserMessageCount(next);\n      // after 5 user messages, prompt signup/login\n      if (next >= 5) {\n        setShowSignupModal(true);\n      }\n    } catch (e) {}\n    const assistantId = makeId(\"a\");\n    const assistantPlaceholder = {\n      id: assistantId,\n      role: \"assistant\",\n      content: \"\",\n      created_at: new Date().toISOString(),\n      streaming: true\n    };\n    pushMessage(assistantPlaceholder);\n    if (abortRef.current) abortRef.current.abort();\n    const ac = new AbortController();\n    abortRef.current = ac;\n    setSending(true);\n    let finalAssistantContent = \"\";\n    try {\n      const res = await fetch(`${API_BASE}/chat?stream=true`, {\n        method: \"POST\",\n        headers: {\n          \"Content-Type\": \"application/json\",\n          Accept: \"text/event-stream\",\n          ...getAuthHeader()\n        },\n        body: JSON.stringify({\n          user_id: userId,\n          thread_id: threadId,\n          message: text\n        }),\n        signal: ac.signal,\n        credentials: 'include'\n      });\n      pushDebug(`/chat response status: ${res.status} content-type=${res.headers.get(\"content-type\")}`);\n      if (!res.ok) {\n        let fallbackText = `Assistant error (${res.status})`;\n        try {\n          var _ref2, _json$reply;\n          const json = await res.json();\n          fallbackText = (_ref2 = (_json$reply = json === null || json === void 0 ? void 0 : json.reply) !== null && _json$reply !== void 0 ? _json$reply : json === null || json === void 0 ? void 0 : json.message) !== null && _ref2 !== void 0 ? _ref2 : fallbackText;\n        } catch (e) {\n          // ignore\n        }\n        const fallback = getFakeResponse(text, preferences) + `\\n\\n(${fallbackText})`;\n        updateMessage(assistantId, {\n          content: fallback,\n          streaming: false\n        });\n        setRawReply(fallback);\n        pushDebug(`/chat non-ok -> ${res.status} fallback set`);\n        return;\n      }\n      const contentType = (res.headers.get(\"content-type\") || \"\").toLowerCase();\n      pushDebug(`/chat content-type resolved: ${contentType}`);\n      if (contentType.includes(\"text/event-stream\")) {\n        // stream as SSE\n        const reader = res.body.getReader();\n        const decoder = new TextDecoder();\n        let sseBuffer = \"\";\n        let accumulated = \"\";\n        let done = false;\n        while (!done) {\n          const {\n            value,\n            done: d\n          } = await reader.read();\n          if (d) {\n            done = true;\n            pushDebug(\"stream reader signalled done\");\n          }\n          if (value) {\n            const chunkStr = decoder.decode(value, {\n              stream: true\n            });\n            pushDebug(`stream chunk len ${chunkStr.length}`);\n            sseBuffer += chunkStr;\n            let sepIndex;\n            while ((sepIndex = sseBuffer.indexOf(\"\\n\\n\")) !== -1) {\n              const rawEvent = sseBuffer.slice(0, sepIndex);\n              sseBuffer = sseBuffer.slice(sepIndex + 2);\n              const lines = rawEvent.split(/\\r?\\n/);\n              for (const line of lines) {\n                const trimmed = line.trim();\n                if (!trimmed) continue;\n                if (trimmed.startsWith(\"data:\")) {\n                  const payload = trimmed.slice(5).trim();\n                  if (payload === \"[DONE]\") {\n                    done = true;\n                    break;\n                  }\n                  try {\n                    var _obj$delta;\n                    const obj = JSON.parse(payload);\n                    const delta = (_obj$delta = obj === null || obj === void 0 ? void 0 : obj.delta) !== null && _obj$delta !== void 0 ? _obj$delta : \"\";\n                    if (delta) {\n                      accumulated += delta;\n                      pushDebug(`delta appended len ${delta.length}`);\n                      updateMessage(assistantId, {\n                        content: accumulated,\n                        streaming: true\n                      });\n                    }\n                  } catch (e) {\n                    accumulated += payload;\n                    pushDebug(`raw payload appended len ${payload.length}`);\n                    updateMessage(assistantId, {\n                      content: accumulated,\n                      streaming: true\n                    });\n                  }\n                }\n              }\n            }\n          }\n        }\n        pushDebug(`stream finished total length ${accumulated.length}`);\n        updateMessage(assistantId, {\n          content: accumulated,\n          streaming: false\n        });\n        finalAssistantContent = accumulated;\n        setRawReply(accumulated);\n      } else {\n        var _ref3, _data$reply;\n        // non-streaming (JSON) response\n        const data = await res.json();\n        const reply = (_ref3 = (_data$reply = data === null || data === void 0 ? void 0 : data.reply) !== null && _data$reply !== void 0 ? _data$reply : data === null || data === void 0 ? void 0 : data.message) !== null && _ref3 !== void 0 ? _ref3 : getFakeResponse(text, preferences);\n        updateMessage(assistantId, {\n          content: reply,\n          streaming: false\n        });\n        finalAssistantContent = reply;\n        setRawReply(typeof reply === \"string\" ? reply : JSON.stringify(reply));\n        pushDebug(`/chat non-stream reply length ${String(finalAssistantContent).length}`);\n      }\n      try {\n        var _ref4, _finalAssistantConten, _messages$find;\n        const assistantPayload = {\n          user_id: userId,\n          thread_id: threadId,\n          role: \"assistant\",\n          content: (_ref4 = (_finalAssistantConten = finalAssistantContent) !== null && _finalAssistantConten !== void 0 ? _finalAssistantConten : (_messages$find = messages.find(m => m.id === assistantId)) === null || _messages$find === void 0 ? void 0 : _messages$find.content) !== null && _ref4 !== void 0 ? _ref4 : \"\"\n        };\n        pushDebug(`POST /message (assistant) -> ${API_BASE}/message (content len ${String(assistantPayload.content).length})`);\n        try {\n          const headers = {\n            \"Content-Type\": \"application/json\",\n            ...getAuthHeader()\n          };\n          void fetch(`${API_BASE}/message`, {\n            method: \"POST\",\n            headers,\n            credentials: 'include',\n            body: JSON.stringify(assistantPayload)\n          });\n        } catch (e) {}\n      } catch (e) {\n        pushDebug(`POST /message (assistant) failed: ${String(e)}`);\n      }\n    } catch (err) {\n      if ((err === null || err === void 0 ? void 0 : err.name) === \"AbortError\") {\n        updateMessage(assistantId, {\n          content: \"(stream aborted)\",\n          streaming: false\n        });\n        pushDebug(\"stream aborted (AbortError)\");\n      } else {\n        const fallback = getFakeResponse(text, preferences) + \" (offline fallback)\";\n        updateMessage(assistantId, {\n          content: fallback,\n          streaming: false\n        });\n        finalAssistantContent = fallback;\n        setRawReply(fallback);\n        pushDebug(`handleSend error: ${String(err)}`);\n      }\n    } finally {\n      setSending(false);\n      abortRef.current = null;\n    }\n  }\n  function renderModalContent() {\n    const content = /*#__PURE__*/_jsxDEV(\"div\", {\n      style: {\n        position: 'fixed',\n        left: 0,\n        right: 0,\n        top: 0,\n        bottom: 0,\n        background: 'rgba(0,0,0,0.4)',\n        display: 'flex',\n        alignItems: 'flex-start',\n        justifyContent: 'center',\n        paddingTop: 72,\n        zIndex: 9999\n      },\n      children: /*#__PURE__*/_jsxDEV(\"div\", {\n        role: \"dialog\",\n        \"aria-modal\": \"true\",\n        \"aria-label\": \"Account dialog\",\n        ref: modalRef,\n        tabIndex: -1,\n        onKeyDown: onModalKeyDown,\n        style: {\n          background: 'linear-gradient(180deg, #06223a, #041a2b)',\n          padding: 18,\n          borderRadius: 12,\n          width: 520,\n          maxWidth: '96%',\n          boxShadow: '0 10px 40px rgba(2,6,23,0.65)',\n          border: '1px solid rgba(255,255,255,0.04)',\n          fontSize: 13,\n          color: '#e6f3ff'\n        },\n        children: [/*#__PURE__*/_jsxDEV(\"h3\", {\n          style: {\n            marginTop: 0,\n            marginBottom: 6,\n            fontSize: 16,\n            fontWeight: 700,\n            color: '#dbeeff'\n          },\n          children: \"Account\"\n        }, void 0, false, {\n          fileName: _jsxFileName,\n          lineNumber: 431,\n          columnNumber: 13\n        }, this), /*#__PURE__*/_jsxDEV(\"p\", {\n          style: {\n            marginTop: 0,\n            marginBottom: 12,\n            color: '#c7ddff',\n            fontSize: 13\n          },\n          children: \"Create an account to save your threads, summaries and journals, or log in to view your existing data.\"\n        }, void 0, false, {\n          fileName: _jsxFileName,\n          lineNumber: 432,\n          columnNumber: 13\n        }, this), !hideModeToggle && /*#__PURE__*/_jsxDEV(\"div\", {\n          style: {\n            display: 'flex',\n            gap: 8,\n            marginBottom: 12\n          },\n          children: [/*#__PURE__*/_jsxDEV(\"button\", {\n            style: {\n              padding: '8px 12px',\n              borderRadius: 8,\n              border: authMode === 'login' ? '1px solid #f3c13a' : '1px solid transparent',\n              background: authMode === 'login' ? '#fff6e6' : 'transparent',\n              fontWeight: 600\n            },\n            onClick: () => setAuthMode('login'),\n            children: \"Log in\"\n          }, void 0, false, {\n            fileName: _jsxFileName,\n            lineNumber: 435,\n            columnNumber: 17\n          }, this), /*#__PURE__*/_jsxDEV(\"button\", {\n            style: {\n              padding: '8px 12px',\n              borderRadius: 8,\n              border: authMode === 'create' ? '1px solid #4aa3ff' : '1px solid transparent',\n              background: authMode === 'create' ? '#eaf6ff' : 'transparent',\n              fontWeight: 600\n            },\n            onClick: () => setAuthMode('create'),\n            children: \"Create account\"\n          }, void 0, false, {\n            fileName: _jsxFileName,\n            lineNumber: 436,\n            columnNumber: 17\n          }, this)]\n        }, void 0, true, {\n          fileName: _jsxFileName,\n          lineNumber: 434,\n          columnNumber: 15\n        }, this), authMode === 'login' ? /*#__PURE__*/_jsxDEV(\"div\", {\n          style: {\n            display: 'flex',\n            flexDirection: 'column',\n            gap: 10\n          },\n          children: [/*#__PURE__*/_jsxDEV(\"input\", {\n            ref: firstInputRef,\n            placeholder: \"Email\",\n            value: loginEmail,\n            onChange: e => setLoginEmail(e.target.value),\n            style: {\n              padding: 10,\n              borderRadius: 8,\n              border: '1px solid rgba(255,255,255,0.06)',\n              background: '#072433',\n              color: '#eaf4ff',\n              fontSize: 13\n            }\n          }, void 0, false, {\n            fileName: _jsxFileName,\n            lineNumber: 442,\n            columnNumber: 17\n          }, this), /*#__PURE__*/_jsxDEV(\"input\", {\n            placeholder: \"Password\",\n            type: \"password\",\n            value: loginPassword,\n            onChange: e => setLoginPassword(e.target.value),\n            style: {\n              padding: 10,\n              borderRadius: 8,\n              border: '1px solid rgba(255,255,255,0.06)',\n              background: '#072433',\n              color: '#eaf4ff',\n              fontSize: 13\n            }\n          }, void 0, false, {\n            fileName: _jsxFileName,\n            lineNumber: 443,\n            columnNumber: 17\n          }, this), /*#__PURE__*/_jsxDEV(\"div\", {\n            style: {\n              display: 'flex',\n              gap: 8,\n              marginTop: 8\n            },\n            children: [/*#__PURE__*/_jsxDEV(\"button\", {\n              style: {\n                background: '#ffd166',\n                border: 'none',\n                padding: '9px 14px',\n                borderRadius: 8,\n                fontWeight: 700,\n                color: '#0f1720'\n              },\n              className: \"prompt-btn\",\n              disabled: authLoading,\n              onClick: async () => {\n                try {\n                  setAuthLoading(true);\n                  const payload = {\n                    email: (loginEmail || \"\").trim(),\n                    password: loginPassword\n                  };\n                  pushDebug(`login attempt ${payload.email}`);\n                  const res = await fetch(`${API_BASE}/users/login`, {\n                    method: 'POST',\n                    headers: {\n                      'Content-Type': 'application/json'\n                    },\n                    credentials: 'include',\n                    body: JSON.stringify(payload)\n                  });\n                  if (!res.ok) {\n                    const txt = await res.text().catch(() => '');\n                    window.dispatchEvent(new CustomEvent('ai_toast', {\n                      detail: {\n                        message: `Login failed: ${res.status} ${txt}`,\n                        kind: 'error'\n                      }\n                    }));\n                    return;\n                  }\n                  const data = await res.json();\n                  const user = data.user;\n                  try {\n                    if (data.token) localStorage.setItem('auth_token_fallback', data.token);\n                  } catch (e) {}\n                  if (user && user.user_id) {\n                    localStorage.setItem('user_id', user.user_id);\n                    localStorage.setItem('ai_user_msg_count', '0');\n                    setUserMessageCount(0);\n                    setModalOpen(false);\n                    setHideModeToggle(false);\n                    window.dispatchEvent(new CustomEvent('ai_toast', {\n                      detail: {\n                        message: `Logged in as ${user.name}`,\n                        kind: 'success'\n                      }\n                    }));\n                    window.dispatchEvent(new CustomEvent('ai_user_changed'));\n                    try {\n                      window.dispatchEvent(new CustomEvent('auth_completed'));\n                    } catch (e) {}\n                  }\n                } catch (e) {\n                  window.dispatchEvent(new CustomEvent('ai_toast', {\n                    detail: {\n                      message: `Login failed: ${String(e)}`,\n                      kind: 'error'\n                    }\n                  }));\n                } finally {\n                  setAuthLoading(false);\n                }\n              },\n              children: \"Log in\"\n            }, void 0, false, {\n              fileName: _jsxFileName,\n              lineNumber: 445,\n              columnNumber: 19\n            }, this), /*#__PURE__*/_jsxDEV(\"button\", {\n              style: {\n                background: 'transparent',\n                border: '1px solid rgba(255,255,255,0.06)',\n                padding: '8px 12px',\n                borderRadius: 8,\n                color: '#dbeeff'\n              },\n              className: \"prompt-btn\",\n              onClick: () => {\n                localStorage.setItem('ai_user_msg_count', '0');\n                setUserMessageCount(0);\n                setModalOpen(false);\n                try {\n                  window.dispatchEvent(new CustomEvent('auth_completed'));\n                } catch (e) {}\n              },\n              children: \"Continue as guest\"\n            }, void 0, false, {\n              fileName: _jsxFileName,\n              lineNumber: 473,\n              columnNumber: 19\n            }, this)]\n          }, void 0, true, {\n            fileName: _jsxFileName,\n            lineNumber: 444,\n            columnNumber: 17\n          }, this)]\n        }, void 0, true, {\n          fileName: _jsxFileName,\n          lineNumber: 441,\n          columnNumber: 15\n        }, this) : /*#__PURE__*/_jsxDEV(\"div\", {\n          style: {\n            display: 'flex',\n            flexDirection: 'column',\n            gap: 10\n          },\n          children: [/*#__PURE__*/_jsxDEV(\"input\", {\n            ref: firstInputRef,\n            placeholder: \"Name\",\n            value: createName,\n            onChange: e => setCreateName(e.target.value),\n            style: {\n              padding: 10,\n              borderRadius: 8,\n              border: '1px solid rgba(255,255,255,0.06)',\n              background: '#072433',\n              color: '#eaf4ff',\n              fontSize: 13\n            }\n          }, void 0, false, {\n            fileName: _jsxFileName,\n            lineNumber: 478,\n            columnNumber: 17\n          }, this), /*#__PURE__*/_jsxDEV(\"input\", {\n            placeholder: \"Email\",\n            value: createEmail,\n            onChange: e => setCreateEmail(e.target.value),\n            style: {\n              padding: 10,\n              borderRadius: 8,\n              border: '1px solid rgba(255,255,255,0.06)',\n              background: '#072433',\n              color: '#eaf4ff',\n              fontSize: 13\n            }\n          }, void 0, false, {\n            fileName: _jsxFileName,\n            lineNumber: 479,\n            columnNumber: 17\n          }, this), /*#__PURE__*/_jsxDEV(\"input\", {\n            placeholder: \"Password\",\n            type: \"password\",\n            value: createPassword,\n            onChange: e => setCreatePassword(e.target.value),\n            style: {\n              padding: 10,\n              borderRadius: 8,\n              border: '1px solid rgba(255,255,255,0.06)',\n              background: '#072433',\n              color: '#eaf4ff',\n              fontSize: 13\n            }\n          }, void 0, false, {\n            fileName: _jsxFileName,\n            lineNumber: 480,\n            columnNumber: 17\n          }, this), /*#__PURE__*/_jsxDEV(\"input\", {\n            placeholder: \"Birth year (e.g. 1990)\",\n            value: createBirthYear,\n            onChange: e => setCreateBirthYear(e.target.value),\n            style: {\n              padding: 10,\n              borderRadius: 8,\n              border: '1px solid rgba(255,255,255,0.06)',\n              background: '#072433',\n              color: '#eaf4ff',\n              fontSize: 13\n            }\n          }, void 0, false, {\n            fileName: _jsxFileName,\n            lineNumber: 481,\n            columnNumber: 17\n          }, this), /*#__PURE__*/_jsxDEV(\"div\", {\n            style: {\n              display: 'flex',\n              gap: 8,\n              marginTop: 8\n            },\n            children: [/*#__PURE__*/_jsxDEV(\"button\", {\n              style: {\n                background: '#2ea0ff',\n                border: 'none',\n                padding: '9px 14px',\n                borderRadius: 8,\n                fontWeight: 700,\n                color: '#04253b'\n              },\n              className: \"prompt-btn\",\n              disabled: authLoading,\n              onClick: async () => {\n                try {\n                  setAuthLoading(true);\n                  const payload = {\n                    name: (createName || \"\").trim(),\n                    email: (createEmail || \"\").trim(),\n                    password: createPassword\n                  };\n                  if (createBirthYear) payload.birth_year = createBirthYear;\n                  const res = await fetch(`${API_BASE}/users/create`, {\n                    method: 'POST',\n                    headers: {\n                      'Content-Type': 'application/json'\n                    },\n                    credentials: 'include',\n                    body: JSON.stringify(payload)\n                  });\n                  if (!res.ok) {\n                    const txt = await res.text().catch(() => '');\n                    window.dispatchEvent(new CustomEvent('ai_toast', {\n                      detail: {\n                        message: `Create account failed: ${res.status} ${txt}`,\n                        kind: 'error'\n                      }\n                    }));\n                    return;\n                  }\n                  const data = await res.json();\n                  const newUser = data.user;\n                  try {\n                    if (data.token) localStorage.setItem('auth_token_fallback', data.token);\n                  } catch (e) {}\n                  if (newUser && newUser.user_id) {\n                    localStorage.setItem('user_id', newUser.user_id);\n                    localStorage.setItem('ai_user_msg_count', '0');\n                    setUserMessageCount(0);\n                    setModalOpen(false);\n                    setHideModeToggle(false);\n                    window.dispatchEvent(new CustomEvent('ai_toast', {\n                      detail: {\n                        message: `Account created: ${newUser.name}`,\n                        kind: 'success'\n                      }\n                    }));\n                    window.dispatchEvent(new CustomEvent('ai_user_changed'));\n                    try {\n                      window.dispatchEvent(new CustomEvent('auth_completed'));\n                    } catch (e) {}\n                  }\n                } catch (e) {\n                  window.dispatchEvent(new CustomEvent('ai_toast', {\n                    detail: {\n                      message: `Create account failed: ${String(e)}`,\n                      kind: 'error'\n                    }\n                  }));\n                } finally {\n                  setAuthLoading(false);\n                }\n              },\n              children: \"Create account\"\n            }, void 0, false, {\n              fileName: _jsxFileName,\n              lineNumber: 483,\n              columnNumber: 19\n            }, this), /*#__PURE__*/_jsxDEV(\"button\", {\n              style: {\n                background: '#2ea0ff',\n                border: 'none',\n                padding: '9px 14px',\n                borderRadius: 8,\n                fontWeight: 700,\n                color: '#04253b'\n              },\n              className: \"prompt-btn\",\n              onClick: () => {\n                localStorage.setItem('ai_user_msg_count', '0');\n                setUserMessageCount(0);\n                setModalOpen(false);\n                try {\n                  window.dispatchEvent(new CustomEvent('auth_completed'));\n                } catch (e) {}\n              },\n              children: \"Continue as guest\"\n            }, void 0, false, {\n              fileName: _jsxFileName,\n              lineNumber: 511,\n              columnNumber: 19\n            }, this)]\n          }, void 0, true, {\n            fileName: _jsxFileName,\n            lineNumber: 482,\n            columnNumber: 17\n          }, this)]\n        }, void 0, true, {\n          fileName: _jsxFileName,\n          lineNumber: 477,\n          columnNumber: 15\n        }, this)]\n      }, void 0, true, {\n        fileName: _jsxFileName,\n        lineNumber: 413,\n        columnNumber: 9\n      }, this)\n    }, void 0, false, {\n      fileName: _jsxFileName,\n      lineNumber: 412,\n      columnNumber: 7\n    }, this);\n    if (typeof document !== 'undefined' && document.body) {\n      try {\n        return /*#__PURE__*/createPortal(content, document.body);\n      } catch (e) {\n        return content;\n      }\n    }\n    return content;\n  }\n  if (onlyShowModal) {\n    return modalOpen ? /*#__PURE__*/_jsxDEV(\"div\", {\n      className: \"chat-panel\",\n      children: renderModalContent()\n    }, void 0, false, {\n      fileName: _jsxFileName,\n      lineNumber: 530,\n      columnNumber: 25\n    }, this) : null;\n  }\n\n  // full UI return\n  return /*#__PURE__*/_jsxDEV(\"div\", {\n    className: \"chat-panel\",\n    children: [(() => {\n      try {\n        const uid = typeof window !== 'undefined' ? localStorage.getItem('user_id') : null;\n        const isAnon = !!uid && uid.startsWith('anon_');\n        const isNewUser = isAnon && messages.length === 0 && userMessageCount === 0;\n        if (isNewUser && !welcomeShown) {\n          return /*#__PURE__*/_jsxDEV(\"div\", {\n            className: \"welcome-banner\",\n            role: \"region\",\n            \"aria-label\": \"Welcome\",\n            children: [/*#__PURE__*/_jsxDEV(\"div\", {\n              className: \"welcome-text\",\n              children: [/*#__PURE__*/_jsxDEV(\"div\", {\n                style: {\n                  fontSize: '1.2rem',\n                  fontWeight: 800,\n                  marginBottom: 6,\n                  color: '#ffffff'\n                },\n                children: \"Welcome to Altar\"\n              }, void 0, false, {\n                fileName: _jsxFileName,\n                lineNumber: 546,\n                columnNumber: 19\n              }, this), /*#__PURE__*/_jsxDEV(\"div\", {\n                style: {\n                  color: '#e6f3ff',\n                  marginBottom: 6\n                },\n                children: \"Use this to:\"\n              }, void 0, false, {\n                fileName: _jsxFileName,\n                lineNumber: 547,\n                columnNumber: 19\n              }, this), /*#__PURE__*/_jsxDEV(\"ul\", {\n                children: [/*#__PURE__*/_jsxDEV(\"li\", {\n                  children: \"untangle work or career thoughts\"\n                }, void 0, false, {\n                  fileName: _jsxFileName,\n                  lineNumber: 549,\n                  columnNumber: 21\n                }, this), /*#__PURE__*/_jsxDEV(\"li\", {\n                  children: \"talk through stress or anxiety\"\n                }, void 0, false, {\n                  fileName: _jsxFileName,\n                  lineNumber: 550,\n                  columnNumber: 21\n                }, this), /*#__PURE__*/_jsxDEV(\"li\", {\n                  children: \"plan your day or week\"\n                }, void 0, false, {\n                  fileName: _jsxFileName,\n                  lineNumber: 551,\n                  columnNumber: 21\n                }, this), /*#__PURE__*/_jsxDEV(\"li\", {\n                  children: \"get conversation summarized and suggested next steps\"\n                }, void 0, false, {\n                  fileName: _jsxFileName,\n                  lineNumber: 552,\n                  columnNumber: 21\n                }, this), /*#__PURE__*/_jsxDEV(\"li\", {\n                  children: \"write privately in your journal\"\n                }, void 0, false, {\n                  fileName: _jsxFileName,\n                  lineNumber: 553,\n                  columnNumber: 21\n                }, this)]\n              }, void 0, true, {\n                fileName: _jsxFileName,\n                lineNumber: 548,\n                columnNumber: 19\n              }, this)]\n            }, void 0, true, {\n              fileName: _jsxFileName,\n              lineNumber: 545,\n              columnNumber: 17\n            }, this), /*#__PURE__*/_jsxDEV(\"div\", {\n              className: \"welcome-actions\",\n              children: /*#__PURE__*/_jsxDEV(\"button\", {\n                ref: welcomeButtonRef,\n                className: \"prompt-btn\",\n                onClick: () => {\n                  try {\n                    localStorage.setItem('ai_welcome_shown', '1');\n                  } catch (e) {}\n                  setWelcomeShown(true);\n                },\n                children: \"Got it\"\n              }, void 0, false, {\n                fileName: _jsxFileName,\n                lineNumber: 557,\n                columnNumber: 19\n              }, this)\n            }, void 0, false, {\n              fileName: _jsxFileName,\n              lineNumber: 556,\n              columnNumber: 17\n            }, this)]\n          }, void 0, true, {\n            fileName: _jsxFileName,\n            lineNumber: 544,\n            columnNumber: 15\n          }, this);\n        }\n      } catch (e) {}\n      return null;\n    })(), /*#__PURE__*/_jsxDEV(\"div\", {\n      className: \"chat-header\",\n      style: {\n        display: 'flex',\n        alignItems: 'center',\n        justifyContent: 'space-between',\n        gap: 12\n      },\n      children: [/*#__PURE__*/_jsxDEV(\"div\", {\n        style: {\n          display: 'flex',\n          alignItems: 'center',\n          gap: 8\n        },\n        children: [typeof onBack === 'function' ? /*#__PURE__*/_jsxDEV(\"button\", {\n          \"aria-label\": \"Back to threads\",\n          onClick: () => {\n            try {\n              onBack && onBack();\n            } catch (e) {}\n          },\n          style: {\n            marginRight: 6\n          },\n          className: \"prompt-btn\",\n          children: \"\\u2190\"\n        }, void 0, false, {\n          fileName: _jsxFileName,\n          lineNumber: 571,\n          columnNumber: 13\n        }, this) : null, /*#__PURE__*/_jsxDEV(\"h3\", {\n          style: {\n            margin: 0,\n            flex: '0 1 auto'\n          },\n          children: (_activeThread$title = activeThread === null || activeThread === void 0 ? void 0 : activeThread.title) !== null && _activeThread$title !== void 0 ? _activeThread$title : \"Thinking space\"\n        }, void 0, false, {\n          fileName: _jsxFileName,\n          lineNumber: 573,\n          columnNumber: 11\n        }, this)]\n      }, void 0, true, {\n        fileName: _jsxFileName,\n        lineNumber: 569,\n        columnNumber: 9\n      }, this), typeof onOpenRight === 'function' ? /*#__PURE__*/_jsxDEV(\"button\", {\n        className: \"mobile-hamburger\",\n        \"aria-label\": \"Toggle summary\",\n        onClick: () => onOpenRight(),\n        style: {\n          marginLeft: 'auto'\n        },\n        children: \"\\u2630\"\n      }, void 0, false, {\n        fileName: _jsxFileName,\n        lineNumber: 576,\n        columnNumber: 11\n      }, this) : null]\n    }, void 0, true, {\n      fileName: _jsxFileName,\n      lineNumber: 568,\n      columnNumber: 7\n    }, this), /*#__PURE__*/_jsxDEV(\"div\", {\n      className: \"messages\",\n      \"aria-live\": \"polite\",\n      ref: messagesRef,\n      children: messages.map(m => /*#__PURE__*/_jsxDEV(\"div\", {\n        className: `msg ${m.role}`,\n        children: [/*#__PURE__*/_jsxDEV(\"div\", {\n          className: \"msg-meta\",\n          style: {\n            fontSize: 12,\n            color: \"#666\"\n          },\n          children: [m.role, m.created_at ? ` • ${new Date(m.created_at).toLocaleTimeString()}` : \"\"]\n        }, void 0, true, {\n          fileName: _jsxFileName,\n          lineNumber: 585,\n          columnNumber: 13\n        }, this), /*#__PURE__*/_jsxDEV(\"pre\", {\n          style: {\n            whiteSpace: \"pre-wrap\",\n            margin: 0\n          },\n          children: m.content\n        }, void 0, false, {\n          fileName: _jsxFileName,\n          lineNumber: 589,\n          columnNumber: 13\n        }, this), m.streaming && /*#__PURE__*/_jsxDEV(\"div\", {\n          style: {\n            fontSize: 12,\n            color: \"#666\"\n          },\n          children: \"Streaming\\u2026\"\n        }, void 0, false, {\n          fileName: _jsxFileName,\n          lineNumber: 590,\n          columnNumber: 29\n        }, this)]\n      }, m.id, true, {\n        fileName: _jsxFileName,\n        lineNumber: 584,\n        columnNumber: 11\n      }, this))\n    }, void 0, false, {\n      fileName: _jsxFileName,\n      lineNumber: 582,\n      columnNumber: 7\n    }, this), /*#__PURE__*/_jsxDEV(\"div\", {\n      className: \"chat-input\",\n      style: {\n        display: \"flex\",\n        gap: 8,\n        marginTop: 8,\n        alignItems: 'flex-start'\n      },\n      children: [/*#__PURE__*/_jsxDEV(\"textarea\", {\n        id: \"chat-input\",\n        name: \"chat_input\",\n        \"aria-label\": \"Chat input\",\n        value: input,\n        placeholder: \"Let's untangle this\",\n        ref: inputRef,\n        onChange: e => setInput(e.target.value),\n        onKeyDown: e => {\n          if (e.key === \"Enter\" && !e.shiftKey) {\n            e.preventDefault();\n            handleSend();\n          }\n        },\n        style: {\n          flex: 1,\n          minHeight: 80\n        }\n      }, void 0, false, {\n        fileName: _jsxFileName,\n        lineNumber: 596,\n        columnNumber: 9\n      }, this), /*#__PURE__*/_jsxDEV(\"div\", {\n        style: {\n          display: \"flex\",\n          flexDirection: \"column\",\n          gap: 8\n        },\n        children: [/*#__PURE__*/_jsxDEV(\"button\", {\n          onClick: handleSend,\n          disabled: sending || !input.trim() || userMessageCount >= 5,\n          style: {\n            minWidth: 100\n          },\n          children: sending ? \"Sending…\" : \"Send\"\n        }, void 0, false, {\n          fileName: _jsxFileName,\n          lineNumber: 613,\n          columnNumber: 13\n        }, this), /*#__PURE__*/_jsxDEV(\"button\", {\n          onClick: () => {\n            if (abortRef.current) abortRef.current.abort();\n          },\n          disabled: !abortRef.current,\n          style: {\n            minWidth: 100\n          },\n          children: \"Cancel\"\n        }, void 0, false, {\n          fileName: _jsxFileName,\n          lineNumber: 616,\n          columnNumber: 11\n        }, this)]\n      }, void 0, true, {\n        fileName: _jsxFileName,\n        lineNumber: 612,\n        columnNumber: 9\n      }, this)]\n    }, void 0, true, {\n      fileName: _jsxFileName,\n      lineNumber: 595,\n      columnNumber: 7\n    }, this), modalOpen && renderModalContent(), suggestions && suggestions.length > 0 && /*#__PURE__*/_jsxDEV(\"div\", {\n      style: {\n        marginTop: 8,\n        display: 'flex',\n        gap: 8,\n        flexWrap: 'wrap'\n      },\n      children: suggestions.map((s, i) => /*#__PURE__*/_jsxDEV(\"button\", {\n        className: \"suggestion-chip\",\n        onClick: () => {\n          // insert suggestion at the current caret position (or append) and focus\n          const area = inputRef.current;\n          if (!area) {\n            setInput(s);\n          } else {\n            var _area$selectionStart, _area$selectionEnd;\n            const start = (_area$selectionStart = area.selectionStart) !== null && _area$selectionStart !== void 0 ? _area$selectionStart : area.value.length;\n            const end = (_area$selectionEnd = area.selectionEnd) !== null && _area$selectionEnd !== void 0 ? _area$selectionEnd : start;\n            const before = area.value.slice(0, start);\n            const after = area.value.slice(end);\n            const nextVal = (before + s + after).trimStart();\n            setInput(nextVal);\n            // set caret right after inserted suggestion\n            setTimeout(() => {\n              area.focus();\n              const caret = (before + s).length;\n              area.setSelectionRange(caret, caret);\n            }, 0);\n          }\n        },\n        style: {\n          padding: '6px 10px',\n          borderRadius: 6\n        },\n        children: s\n      }, i, false, {\n        fileName: _jsxFileName,\n        lineNumber: 635,\n        columnNumber: 13\n      }, this))\n    }, void 0, false, {\n      fileName: _jsxFileName,\n      lineNumber: 633,\n      columnNumber: 9\n    }, this), /*#__PURE__*/_jsxDEV(\"div\", {\n      style: {\n        marginTop: 8\n      },\n      children: /*#__PURE__*/_jsxDEV(\"button\", {\n        className: \"prompt-btn\",\n        onClick: async () => {\n          if (!activeThread) return;\n          if (!window.confirm(\"Delete this chat history for the selected thread?\")) return;\n          const userId = localStorage.getItem(\"user_id\") || \"u1\";\n          try {\n            const resp = await fetch(`${API_BASE}/messages/${encodeURIComponent(userId)}/${encodeURIComponent(activeThread.thread_id)}`, {\n              method: \"DELETE\",\n              headers: {\n                \"Content-Type\": \"application/json\",\n                ...getAuthHeader()\n              },\n              credentials: 'include'\n            });\n            if (!resp.ok) {\n              const body = await resp.text().catch(() => \"\");\n              window.dispatchEvent(new CustomEvent('ai_toast', {\n                detail: {\n                  message: `Failed to delete chat: ${resp.status} ${body}`,\n                  kind: 'error'\n                }\n              }));\n              return;\n            }\n            setMessages([]);\n            window.dispatchEvent(new CustomEvent('ai_toast', {\n              detail: {\n                message: 'Chat history deleted.',\n                kind: 'success'\n              }\n            }));\n          } catch (e) {\n            window.dispatchEvent(new CustomEvent('ai_toast', {\n              detail: {\n                message: `Delete failed: ${String(e)}`,\n                kind: 'error'\n              }\n            }));\n          }\n        },\n        children: \"Delete Chat\"\n      }, void 0, false, {\n        fileName: _jsxFileName,\n        lineNumber: 669,\n        columnNumber: 9\n      }, this)\n    }, void 0, false, {\n      fileName: _jsxFileName,\n      lineNumber: 668,\n      columnNumber: 7\n    }, this)]\n  }, void 0, true, {\n    fileName: _jsxFileName,\n    lineNumber: 535,\n    columnNumber: 5\n  }, this);\n}\n_s(ChatPanel, \"+2pdjrpLYs9cKMCrHMcENQcaH18=\");\n_c = ChatPanel;\nfunction getFakeResponse(input, preferences) {\n  if (!preferences) return \"I’m here to listen.\";\n  if (preferences.default_tone === \"direct\") {\n    return \"Let’s simplify this. What decision are you actually trying to make?\";\n  }\n  if (preferences.depth_level === \"deep\") {\n    return \"Let me reflect this back. It sounds like you’re torn between safety and growth. What’s driving that tension right now?\";\n  }\n  return \"I’m hearing a few competing thoughts here. Want to slow down and look at them one by one?\";\n}\nvar _c;\n$RefreshReg$(_c, \"ChatPanel\");","map":{"version":3,"names":["useEffect","useRef","useState","createPortal","jsxDEV","_jsxDEV","makeId","prefix","Date","now","Math","floor","random","ChatPanel","activeThread","session","preferences","onOpenRight","showSignupModal","propShowSignupModal","setShowSignupModal","propSetShowSignupModal","onlyShowModal","propOnlyShowModal","onBack","_s","_activeThread$title","API_BASE","window","process","env","REACT_APP_API_BASE","DEBUG","getAuthHeader","t","localStorage","getItem","Authorization","e","input","setInput","suggestions","setSuggestions","messages","setMessages","userMessageCount","setUserMessageCount","welcomeShown","setWelcomeShown","welcomeButtonRef","authMode","setAuthMode","loginEmail","setLoginEmail","loginPassword","setLoginPassword","createName","setCreateName","createEmail","setCreateEmail","createPassword","setCreatePassword","createBirthYear","setCreateBirthYear","authLoading","setAuthLoading","hideModeToggle","setHideModeToggle","sending","setSending","abortRef","inputRef","messagesRef","modalRef","firstInputRef","prevFocusedRef","existing","anon","setItem","cnt","Number","shown","Boolean","uid","isAnon","startsWith","isNewUser","length","setTimeout","_welcomeButtonRef$cur","current","focus","handler","_e$detail","arr","detail","map","s","String","trim","filter","err","addEventListener","removeEventListener","modalOpen","setModalOpen","hintHandler","_e$detail2","mode","document","activeElement","_prevFocusedRef$curre","onModalKeyDown","key","container","focusable","querySelectorAll","first","last","shiftKey","preventDefault","starterByThread","t1","t2","defaults","thread_id","Array","isArray","mapped","m","_m$role","_ref","_m$content","_m$created_at","id","entry_id","role","source","content","text","created_at","undefined","el","scrollTop","scrollHeight","updateMessage","patch","prev","pushMessage","msg","pushDebug","_entry","console","debug","setRawReply","_","handleSend","_activeThread$thread_","userMsg","toISOString","userId","threadId","userPayload","user_id","headers","fetch","method","credentials","body","JSON","stringify","next","assistantId","assistantPlaceholder","streaming","abort","ac","AbortController","finalAssistantContent","res","Accept","message","signal","status","get","ok","fallbackText","_ref2","_json$reply","json","reply","fallback","getFakeResponse","contentType","toLowerCase","includes","reader","getReader","decoder","TextDecoder","sseBuffer","accumulated","done","value","d","read","chunkStr","decode","stream","sepIndex","indexOf","rawEvent","slice","lines","split","line","trimmed","payload","_obj$delta","obj","parse","delta","_ref3","_data$reply","data","_ref4","_finalAssistantConten","_messages$find","assistantPayload","find","name","renderModalContent","style","position","left","right","top","bottom","background","display","alignItems","justifyContent","paddingTop","zIndex","children","ref","tabIndex","onKeyDown","padding","borderRadius","width","maxWidth","boxShadow","border","fontSize","color","marginTop","marginBottom","fontWeight","fileName","_jsxFileName","lineNumber","columnNumber","gap","onClick","flexDirection","placeholder","onChange","target","type","className","disabled","email","password","txt","catch","dispatchEvent","CustomEvent","kind","user","token","birth_year","newUser","marginRight","margin","flex","title","marginLeft","toLocaleTimeString","whiteSpace","minHeight","minWidth","flexWrap","i","area","_area$selectionStart","_area$selectionEnd","start","selectionStart","end","selectionEnd","before","after","nextVal","trimStart","caret","setSelectionRange","confirm","resp","encodeURIComponent","_c","default_tone","depth_level","$RefreshReg$"],"sources":["/Users/ankurporwal/Documents/PersonalManagementAgent/Frontend/src/components/chat/ChatPanel.tsx"],"sourcesContent":["import { Thread, Session, UserPreferences } from \"../../types/thinking\";\nimport { useEffect, useRef, useState } from \"react\";\nimport { createPortal } from 'react-dom';\n\ninterface ChatPanelProps {\n  activeThread?: Thread | null;\n  session?: Session | null;\n  preferences: UserPreferences;\n  onOpenRight?: () => void;\n  showSignupModal?: boolean;\n  setShowSignupModal?: (v: boolean) => void;\n  onlyShowModal?: boolean;\n  onBack?: () => void;\n}\n\ntype Message = {\n  id: string;\n  role: \"user\" | \"assistant\" | \"system\";\n  content: string;\n  created_at?: string;\n  streaming?: boolean;\n};\n\nfunction makeId(prefix = \"m\") {\n  return `${prefix}${Date.now()}${Math.floor(Math.random() * 1000)}`;\n}\n\nexport default function ChatPanel({ activeThread, session, preferences, onOpenRight, showSignupModal: propShowSignupModal, setShowSignupModal: propSetShowSignupModal, onlyShowModal: propOnlyShowModal, onBack, }: ChatPanelProps) {\n  const API_BASE = (typeof window !== \"undefined\" && (window as any).API_BASE) || (process.env.REACT_APP_API_BASE as string) || \"http://localhost:8000\";\n  const DEBUG = false;\n  const getAuthHeader = () => {\n    try { const t = localStorage.getItem('auth_token_fallback') || localStorage.getItem('token'); return t ? { Authorization: `Bearer ${t}` } : {}; } catch (e) { return {}; }\n  };\n\n  const [input, setInput] = useState(\"\");\n  const [suggestions, setSuggestions] = useState<string[]>([]);\n  const [messages, setMessages] = useState<Message[]>([]);\n  const [userMessageCount, setUserMessageCount] = useState<number>(0);\n  const [welcomeShown, setWelcomeShown] = useState<boolean>(false);\n  const welcomeButtonRef = useRef<HTMLButtonElement | null>(null);\n  const [showSignupModal, setShowSignupModal] = useState<boolean>(false);\n  // signupName / signupEmail removed: not used in UI (lint cleanup)\n  const [authMode, setAuthMode] = useState<'login'|'create'>('create');\n  const [loginEmail, setLoginEmail] = useState<string>(\"\");\n  const [loginPassword, setLoginPassword] = useState<string>(\"\");\n  const [createName, setCreateName] = useState<string>(\"\");\n  const [createEmail, setCreateEmail] = useState<string>(\"\");\n  const [createPassword, setCreatePassword] = useState<string>(\"\");\n  const [createBirthYear, setCreateBirthYear] = useState<string>(\"\");\n  const [authLoading, setAuthLoading] = useState<boolean>(false);\n  const [hideModeToggle, setHideModeToggle] = useState<boolean>(false);\n  const [sending, setSending] = useState(false);\n  const abortRef = useRef<AbortController | null>(null);\n  const inputRef = useRef<HTMLTextAreaElement | null>(null);\n  const messagesRef = useRef<HTMLDivElement | null>(null);\n  const modalRef = useRef<HTMLDivElement | null>(null);\n  const firstInputRef = useRef<HTMLInputElement | null>(null);\n  const prevFocusedRef = useRef<HTMLElement | null>(null);\n\n  // Ensure a user_id exists (anonymous) so messages can be stored server-side\n  useEffect(() => {\n    const existing = localStorage.getItem(\"user_id\");\n    if (!existing) {\n      const anon = `anon_${Date.now()}`;\n      localStorage.setItem(\"user_id\", anon);\n      localStorage.setItem(\"ai_user_msg_count\", \"0\");\n      setUserMessageCount(0);\n    } else {\n      const cnt = Number(localStorage.getItem(\"ai_user_msg_count\") || \"0\") || 0;\n      setUserMessageCount(cnt);\n    }\n    try {\n      const shown = localStorage.getItem('ai_welcome_shown');\n      setWelcomeShown(Boolean(shown));\n    } catch (e) {}\n  }, []);\n\n  // Focus the welcome dismiss button when banner is shown for accessibility\n  useEffect(() => {\n    try {\n      const uid = typeof window !== 'undefined' ? localStorage.getItem('user_id') : null;\n      const isAnon = !!uid && uid.startsWith('anon_');\n      const isNewUser = isAnon && messages.length === 0 && (userMessageCount === 0);\n      if (!welcomeShown && isNewUser) {\n        setTimeout(() => {\n          try { welcomeButtonRef.current?.focus(); } catch (e) {}\n        }, 50);\n      }\n    } catch (e) {}\n  // eslint-disable-next-line react-hooks/exhaustive-deps\n  }, [welcomeShown, messages.length, userMessageCount]);\n\n  // listen for suggestion updates from RightPanel\n  useEffect(() => {\n    function handler(e: any) {\n      try {\n        const arr = (e?.detail?.suggestions || []).map((s: any) => String(s).trim()).filter(Boolean);\n        setSuggestions(arr);\n      } catch (err) {\n        // ignore\n      }\n    }\n    window.addEventListener(\"ai_suggestions\", handler as EventListener);\n    return () => window.removeEventListener(\"ai_suggestions\", handler as EventListener);\n  }, []);\n\n  // If the page-level controller passed modal props, prefer those; otherwise\n  // use internal state. Also listen for `open_signup_modal_hint` which carries\n  // a short-lived mode hint from the page when it mounts ChatPanel.\n  const modalOpen = typeof propShowSignupModal === 'boolean' ? propShowSignupModal : showSignupModal;\n  const setModalOpen = propSetShowSignupModal || setShowSignupModal;\n  const onlyShowModal = typeof propOnlyShowModal === 'boolean' ? propOnlyShowModal : false;\n\n  useEffect(() => {\n    function hintHandler(e: any) {\n      try {\n        const mode = e?.detail?.mode;\n        if (mode === 'login' || mode === 'create') {\n          setAuthMode(mode);\n          setHideModeToggle(true);\n        }\n        setModalOpen(true);\n      } catch (err) {}\n    }\n    window.addEventListener('open_signup_modal_hint', hintHandler as EventListener);\n    return () => window.removeEventListener('open_signup_modal_hint', hintHandler as EventListener);\n  }, [setModalOpen]);\n\n  // Manage focus when modal opens/closes (accessibility)\n  useEffect(() => {\n    if (modalOpen) {\n      try {\n        prevFocusedRef.current = document.activeElement as HTMLElement;\n        setTimeout(() => {\n          // focus the first relevant input depending on mode\n          if (firstInputRef.current) {\n            firstInputRef.current.focus();\n          } else if (modalRef.current) {\n            modalRef.current.focus();\n          }\n        }, 0);\n      } catch (e) {}\n    } else {\n      // restore focus\n      try {\n        prevFocusedRef.current?.focus();\n      } catch (e) {}\n    }\n  }, [modalOpen]);\n\n  // basic focus trap: keep tab inside modal\n  function onModalKeyDown(e: React.KeyboardEvent) {\n    if (e.key !== 'Tab') return;\n    const container = modalRef.current;\n    if (!container) return;\n    const focusable = container.querySelectorAll<HTMLElement>(\"a[href], button:not([disabled]), textarea, input, select, [tabindex]:not([tabindex='-1'])\");\n    if (!focusable || focusable.length === 0) return;\n    const first = focusable[0];\n    const last = focusable[focusable.length - 1];\n    if (!e.shiftKey && document.activeElement === last) {\n      e.preventDefault();\n      (first as HTMLElement).focus();\n    }\n    if (e.shiftKey && document.activeElement === first) {\n      e.preventDefault();\n      (last as HTMLElement).focus();\n    }\n  }\n\n  // For anonymous / new users with no messages, show thread-specific starter suggestions\n  useEffect(() => {\n    try {\n      const uid = typeof window !== \"undefined\" ? localStorage.getItem('user_id') : null;\n      if (!uid || !uid.startsWith('anon_')) return; // only for anonymous new users\n    } catch (e) {\n      return;\n    }\n\n    if (!activeThread) return;\n    if (messages.length > 0) return; // user already has messages\n    if (suggestions && suggestions.length > 0) return; // don't override existing suggestions\n\n    const starterByThread: Record<string, string[]> = {\n      t1: [\"I'm thinking about changing roles but unsure which direction feels right.\"],\n      t2: [\"I keep ruminating at night and can't fall asleep.\"],\n    };\n\n    const defaults = starterByThread[activeThread.thread_id] || [];\n    if (defaults.length) setSuggestions(defaults);\n  }, [activeThread, messages, suggestions]);\n\n  useEffect(() => {\n    if (session?.messages && Array.isArray(session.messages)) {\n      const mapped = session.messages.map((m: any) => ({\n        id: m.entry_id ? String(m.entry_id) : makeId(\"s\"),\n        role: m.role ?? (m.source === \"assistant\" ? \"assistant\" : \"user\"),\n        content: m.content ?? m.text ?? \"\",\n        created_at: m.created_at ?? undefined,\n      }));\n      setMessages(mapped);\n    } else {\n      setMessages([]);\n    }\n  }, [session]);\n\n  // auto-scroll to bottom when messages change\n  useEffect(() => {\n    try {\n      const el = messagesRef.current;\n      if (el) {\n        el.scrollTop = el.scrollHeight;\n      }\n    } catch (e) {}\n  }, [messages]);\n\n  function updateMessage(id: string, patch: Partial<Message>) {\n    setMessages((prev) => prev.map((m) => (m.id === id ? { ...m, ...patch } : m)));\n  }\n\n  function pushMessage(msg: Message) {\n    setMessages((prev) => [...prev, msg]);\n  }\n\n  function pushDebug(_entry: string) {\n    // debug disabled — no-op to preserve call sites\n    if (DEBUG) console.debug(\"DEBUG_LOG:\", _entry);\n  }\n\n  // legacy debug setter (no-op) kept so existing code that calls setRawReply doesn't break\n  const setRawReply = (_: any) => {};\n\n  async function handleSend() {\n    const text = input.trim();\n    if (!text || sending) return;\n\n    pushDebug(`handleSend invoked — text length ${text.length}`);\n\n    const userMsg: Message = { id: makeId(\"u\"), role: \"user\", content: text, created_at: new Date().toISOString() };\n    pushMessage(userMsg);\n    setInput(\"\");\n\n    const userId = localStorage.getItem(\"user_id\") || \"u1\";\n    const threadId = activeThread?.thread_id ?? \"t1\";\n\n    try {\n      const userPayload = { user_id: userId, thread_id: threadId, role: \"user\", content: text };\n      if (DEBUG) console.debug(\"POST /message (user):\", userPayload);\n      pushDebug(`POST /message (user) -> ${API_BASE}/message`);\n                        try {\n                          const headers: any = { \"Content-Type\": \"application/json\", ...(getAuthHeader()) };\n                          void fetch(`${API_BASE}/message`, {\n                            method: \"POST\",\n                            headers,\n                            credentials: 'include',\n                            body: JSON.stringify(userPayload),\n                          });\n                        } catch (e) {}\n    } catch (e) {\n      pushDebug(`POST /message (user) failed: ${String(e)}`);\n    }\n\n      // increment anonymous user message count and persist\n      try {\n        const prev = Number(localStorage.getItem(\"ai_user_msg_count\") || \"0\") || 0;\n        const next = prev + 1;\n        localStorage.setItem(\"ai_user_msg_count\", String(next));\n        setUserMessageCount(next);\n        // after 5 user messages, prompt signup/login\n        if (next >= 5) {\n          setShowSignupModal(true);\n        }\n      } catch (e) {}\n\n    const assistantId = makeId(\"a\");\n    const assistantPlaceholder: Message = { id: assistantId, role: \"assistant\", content: \"\", created_at: new Date().toISOString(), streaming: true };\n    pushMessage(assistantPlaceholder);\n\n    if (abortRef.current) abortRef.current.abort();\n    const ac = new AbortController();\n    abortRef.current = ac;\n\n    setSending(true);\n    let finalAssistantContent = \"\";\n    try {\n      const res = await fetch(`${API_BASE}/chat?stream=true`, {\n        method: \"POST\",\n        headers: { \"Content-Type\": \"application/json\", Accept: \"text/event-stream\", ...(getAuthHeader()) },\n        body: JSON.stringify({ user_id: userId, thread_id: threadId, message: text }),\n        signal: ac.signal,\n        credentials: 'include',\n      });\n\n      pushDebug(`/chat response status: ${res.status} content-type=${res.headers.get(\"content-type\")}`);\n\n      if (!res.ok) {\n        let fallbackText = `Assistant error (${res.status})`;\n        try {\n          const json = await res.json();\n          fallbackText = json?.reply ?? json?.message ?? fallbackText;\n        } catch (e) {\n          // ignore\n        }\n        const fallback = getFakeResponse(text, preferences) + `\\n\\n(${fallbackText})`;\n        updateMessage(assistantId, { content: fallback, streaming: false });\n        setRawReply(fallback);\n        pushDebug(`/chat non-ok -> ${res.status} fallback set`);\n        return;\n      }\n\n      const contentType = (res.headers.get(\"content-type\") || \"\").toLowerCase();\n      pushDebug(`/chat content-type resolved: ${contentType}`);\n\n      if (contentType.includes(\"text/event-stream\")) {\n        // stream as SSE\n        const reader = res.body.getReader();\n        const decoder = new TextDecoder();\n        let sseBuffer = \"\";\n        let accumulated = \"\";\n        let done = false;\n        while (!done) {\n          const { value, done: d } = await reader.read();\n          if (d) {\n            done = true;\n            pushDebug(\"stream reader signalled done\");\n          }\n          if (value) {\n            const chunkStr = decoder.decode(value, { stream: true });\n            pushDebug(`stream chunk len ${chunkStr.length}`);\n            sseBuffer += chunkStr;\n\n            let sepIndex;\n            while ((sepIndex = sseBuffer.indexOf(\"\\n\\n\")) !== -1) {\n              const rawEvent = sseBuffer.slice(0, sepIndex);\n              sseBuffer = sseBuffer.slice(sepIndex + 2);\n\n              const lines = rawEvent.split(/\\r?\\n/);\n              for (const line of lines) {\n                const trimmed = line.trim();\n                if (!trimmed) continue;\n                if (trimmed.startsWith(\"data:\")) {\n                  const payload = trimmed.slice(5).trim();\n                  if (payload === \"[DONE]\") {\n                    done = true;\n                    break;\n                  }\n                  try {\n                    const obj = JSON.parse(payload);\n                    const delta = obj?.delta ?? \"\";\n                    if (delta) {\n                      accumulated += delta;\n                      pushDebug(`delta appended len ${delta.length}`);\n                      updateMessage(assistantId, { content: accumulated, streaming: true });\n                    }\n                  } catch (e) {\n                    accumulated += payload;\n                    pushDebug(`raw payload appended len ${payload.length}`);\n                    updateMessage(assistantId, { content: accumulated, streaming: true });\n                  }\n                }\n              }\n            }\n          }\n        }\n        pushDebug(`stream finished total length ${accumulated.length}`);\n        updateMessage(assistantId, { content: accumulated, streaming: false });\n        finalAssistantContent = accumulated;\n        setRawReply(accumulated);\n      } else {\n        // non-streaming (JSON) response\n        const data = await res.json();\n        const reply = data?.reply ?? data?.message ?? getFakeResponse(text, preferences);\n        updateMessage(assistantId, { content: reply, streaming: false });\n        finalAssistantContent = reply;\n        setRawReply(typeof reply === \"string\" ? reply : JSON.stringify(reply));\n        pushDebug(`/chat non-stream reply length ${String(finalAssistantContent).length}`);\n      }\n\n      try {\n        const assistantPayload = { user_id: userId, thread_id: threadId, role: \"assistant\", content: finalAssistantContent ?? messages.find((m) => m.id === assistantId)?.content ?? \"\" };\n        pushDebug(`POST /message (assistant) -> ${API_BASE}/message (content len ${String(assistantPayload.content).length})`);\n      try {\n        const headers: any = { \"Content-Type\": \"application/json\", ...(getAuthHeader()) };\n        void fetch(`${API_BASE}/message`, {\n          method: \"POST\",\n          headers,\n          credentials: 'include',\n          body: JSON.stringify(assistantPayload),\n        });\n      } catch (e) {}\n      } catch (e) {\n        pushDebug(`POST /message (assistant) failed: ${String(e)}`);\n      }\n    } catch (err: any) {\n      if (err?.name === \"AbortError\") {\n        updateMessage(assistantId, { content: \"(stream aborted)\", streaming: false });\n        pushDebug(\"stream aborted (AbortError)\");\n      } else {\n        const fallback = getFakeResponse(text, preferences) + \" (offline fallback)\";\n        updateMessage(assistantId, { content: fallback, streaming: false });\n        finalAssistantContent = fallback;\n        setRawReply(fallback);\n        pushDebug(`handleSend error: ${String(err)}`);\n      }\n    } finally {\n      setSending(false);\n      abortRef.current = null;\n    }\n  }\n\n  function renderModalContent() {\n    const content = (\n      <div style={{ position: 'fixed', left: 0, right: 0, top: 0, bottom: 0, background: 'rgba(0,0,0,0.4)', display: 'flex', alignItems: 'flex-start', justifyContent: 'center', paddingTop: 72, zIndex: 9999 }}>\n        <div\n          role=\"dialog\"\n          aria-modal=\"true\"\n          aria-label=\"Account dialog\"\n          ref={modalRef}\n          tabIndex={-1}\n          onKeyDown={onModalKeyDown}\n          style={{\n            background: 'linear-gradient(180deg, #06223a, #041a2b)',\n            padding: 18,\n            borderRadius: 12,\n            width: 520,\n            maxWidth: '96%',\n            boxShadow: '0 10px 40px rgba(2,6,23,0.65)',\n            border: '1px solid rgba(255,255,255,0.04)',\n            fontSize: 13,\n            color: '#e6f3ff'\n          }}>\n            <h3 style={{ marginTop: 0, marginBottom: 6, fontSize: 16, fontWeight: 700, color: '#dbeeff' }}>Account</h3>\n            <p style={{ marginTop: 0, marginBottom: 12, color: '#c7ddff', fontSize: 13 }}>Create an account to save your threads, summaries and journals, or log in to view your existing data.</p>\n            {!hideModeToggle && (\n              <div style={{ display: 'flex', gap: 8, marginBottom: 12 }}>\n                <button style={{ padding: '8px 12px', borderRadius: 8, border: authMode === 'login' ? '1px solid #f3c13a' : '1px solid transparent', background: authMode === 'login' ? '#fff6e6' : 'transparent', fontWeight: 600 }} onClick={() => setAuthMode('login')}>Log in</button>\n                <button style={{ padding: '8px 12px', borderRadius: 8, border: authMode === 'create' ? '1px solid #4aa3ff' : '1px solid transparent', background: authMode === 'create' ? '#eaf6ff' : 'transparent', fontWeight: 600 }} onClick={() => setAuthMode('create')}>Create account</button>\n              </div>\n            )}\n\n            {authMode === 'login' ? (\n              <div style={{ display: 'flex', flexDirection: 'column', gap: 10 }}>\n                <input ref={firstInputRef} placeholder=\"Email\" value={loginEmail} onChange={(e) => setLoginEmail(e.target.value)} style={{ padding: 10, borderRadius: 8, border: '1px solid rgba(255,255,255,0.06)', background: '#072433', color: '#eaf4ff', fontSize: 13 }} />\n                <input placeholder=\"Password\" type=\"password\" value={loginPassword} onChange={(e) => setLoginPassword(e.target.value)} style={{ padding: 10, borderRadius: 8, border: '1px solid rgba(255,255,255,0.06)', background: '#072433', color: '#eaf4ff', fontSize: 13 }} />\n                <div style={{ display: 'flex', gap: 8, marginTop: 8 }}>\n                  <button style={{ background: '#ffd166', border: 'none', padding: '9px 14px', borderRadius: 8, fontWeight: 700, color: '#0f1720' }} className=\"prompt-btn\" disabled={authLoading} onClick={async () => {\n                    try {\n                      setAuthLoading(true);\n                      const payload = { email: (loginEmail || \"\").trim(), password: loginPassword };\n                      pushDebug(`login attempt ${payload.email}`);\n                      const res = await fetch(`${API_BASE}/users/login`, { method: 'POST', headers: { 'Content-Type': 'application/json' }, credentials: 'include', body: JSON.stringify(payload) });\n                      if (!res.ok) {\n                        const txt = await res.text().catch(() => '');\n                        window.dispatchEvent(new CustomEvent('ai_toast', { detail: { message: `Login failed: ${res.status} ${txt}`, kind: 'error' } }));\n                        return;\n                      }\n                      const data = await res.json();\n                      const user = data.user;\n                      try { if (data.token) localStorage.setItem('auth_token_fallback', data.token); } catch (e) {}\n                      if (user && user.user_id) {\n                        localStorage.setItem('user_id', user.user_id);\n                        localStorage.setItem('ai_user_msg_count', '0');\n                        setUserMessageCount(0);\n                        setModalOpen(false);\n                        setHideModeToggle(false);\n                        window.dispatchEvent(new CustomEvent('ai_toast', { detail: { message: `Logged in as ${user.name}`, kind: 'success' } }));\n                        window.dispatchEvent(new CustomEvent('ai_user_changed'));\n                        try { window.dispatchEvent(new CustomEvent('auth_completed')); } catch (e) {}\n                      }\n                    } catch (e) {\n                      window.dispatchEvent(new CustomEvent('ai_toast', { detail: { message: `Login failed: ${String(e)}`, kind: 'error' } }));\n                    } finally { setAuthLoading(false); }\n                  }}>Log in</button>\n                  <button style={{ background: 'transparent', border: '1px solid rgba(255,255,255,0.06)', padding: '8px 12px', borderRadius: 8, color: '#dbeeff' }} className=\"prompt-btn\" onClick={() => { localStorage.setItem('ai_user_msg_count', '0'); setUserMessageCount(0); setModalOpen(false); try { window.dispatchEvent(new CustomEvent('auth_completed')); } catch (e) {} }}>Continue as guest</button>\n                </div>\n              </div>\n            ) : (\n              <div style={{ display: 'flex', flexDirection: 'column', gap: 10 }}>\n                <input ref={firstInputRef} placeholder=\"Name\" value={createName} onChange={(e) => setCreateName(e.target.value)} style={{ padding: 10, borderRadius: 8, border: '1px solid rgba(255,255,255,0.06)', background: '#072433', color: '#eaf4ff', fontSize: 13 }} />\n                <input placeholder=\"Email\" value={createEmail} onChange={(e) => setCreateEmail(e.target.value)} style={{ padding: 10, borderRadius: 8, border: '1px solid rgba(255,255,255,0.06)', background: '#072433', color: '#eaf4ff', fontSize: 13 }} />\n                <input placeholder=\"Password\" type=\"password\" value={createPassword} onChange={(e) => setCreatePassword(e.target.value)} style={{ padding: 10, borderRadius: 8, border: '1px solid rgba(255,255,255,0.06)', background: '#072433', color: '#eaf4ff', fontSize: 13 }} />\n                <input placeholder=\"Birth year (e.g. 1990)\" value={createBirthYear} onChange={(e) => setCreateBirthYear(e.target.value)} style={{ padding: 10, borderRadius: 8, border: '1px solid rgba(255,255,255,0.06)', background: '#072433', color: '#eaf4ff', fontSize: 13 }} />\n                <div style={{ display: 'flex', gap: 8, marginTop: 8 }}>\n                  <button style={{ background: '#2ea0ff', border: 'none', padding: '9px 14px', borderRadius: 8, fontWeight: 700, color: '#04253b' }} className=\"prompt-btn\" disabled={authLoading} onClick={async () => {\n                    try {\n                      setAuthLoading(true);\n                      const payload: any = { name: (createName || \"\").trim(), email: (createEmail || \"\").trim(), password: createPassword };\n                      if (createBirthYear) payload.birth_year = createBirthYear;\n                      const res = await fetch(`${API_BASE}/users/create`, { method: 'POST', headers: { 'Content-Type': 'application/json' }, credentials: 'include', body: JSON.stringify(payload) });\n                      if (!res.ok) {\n                        const txt = await res.text().catch(() => '');\n                        window.dispatchEvent(new CustomEvent('ai_toast', { detail: { message: `Create account failed: ${res.status} ${txt}`, kind: 'error' } }));\n                        return;\n                      }\n                      const data = await res.json();\n                      const newUser = data.user;\n                      try { if (data.token) localStorage.setItem('auth_token_fallback', data.token); } catch (e) {}\n                      if (newUser && newUser.user_id) {\n                        localStorage.setItem('user_id', newUser.user_id);\n                        localStorage.setItem('ai_user_msg_count', '0');\n                        setUserMessageCount(0);\n                        setModalOpen(false);\n                        setHideModeToggle(false);\n                        window.dispatchEvent(new CustomEvent('ai_toast', { detail: { message: `Account created: ${newUser.name}`, kind: 'success' } }));\n                        window.dispatchEvent(new CustomEvent('ai_user_changed'));\n                        try { window.dispatchEvent(new CustomEvent('auth_completed')); } catch (e) {}\n                      }\n                    } catch (e) {\n                      window.dispatchEvent(new CustomEvent('ai_toast', { detail: { message: `Create account failed: ${String(e)}`, kind: 'error' } }));\n                    } finally { setAuthLoading(false); }\n                  }}>Create account</button>\n                  <button style={{ background: '#2ea0ff', border: 'none', padding: '9px 14px', borderRadius: 8, fontWeight: 700, color: '#04253b' }} className=\"prompt-btn\" onClick={() => { localStorage.setItem('ai_user_msg_count', '0'); setUserMessageCount(0); setModalOpen(false); try { window.dispatchEvent(new CustomEvent('auth_completed')); } catch (e) {} }}>Continue as guest</button>\n                </div>\n              </div>\n            )}\n        </div>\n      </div>\n    );\n\n    if (typeof document !== 'undefined' && document.body) {\n      try {\n        return createPortal(content, document.body);\n      } catch (e) {\n        return content;\n      }\n    }\n    return content;\n  }\n\n  if (onlyShowModal) {\n    return modalOpen ? (<div className=\"chat-panel\">{renderModalContent()}</div>) : null;\n  }\n\n  // full UI return\n  return (\n    <div className=\"chat-panel\">\n      {/* Welcome banner for new anonymous users */}\n      {(() => {\n        try {\n          const uid = typeof window !== 'undefined' ? localStorage.getItem('user_id') : null;\n          const isAnon = !!uid && uid.startsWith('anon_');\n          const isNewUser = isAnon && messages.length === 0 && (userMessageCount === 0);\n          if (isNewUser && !welcomeShown) {\n            return (\n              <div className=\"welcome-banner\" role=\"region\" aria-label=\"Welcome\">\n                <div className=\"welcome-text\">\n                  <div style={{ fontSize: '1.2rem', fontWeight: 800, marginBottom: 6, color: '#ffffff' }}>Welcome to Altar</div>\n                  <div style={{ color: '#e6f3ff', marginBottom: 6 }}>Use this to:</div>\n                  <ul>\n                    <li>untangle work or career thoughts</li>\n                    <li>talk through stress or anxiety</li>\n                    <li>plan your day or week</li>\n                    <li>get conversation summarized and suggested next steps</li>\n                    <li>write privately in your journal</li>\n                  </ul>\n                </div>\n                <div className=\"welcome-actions\">\n                  <button ref={welcomeButtonRef} className=\"prompt-btn\" onClick={() => {\n                    try { localStorage.setItem('ai_welcome_shown', '1'); } catch (e) {}\n                    setWelcomeShown(true);\n                  }}>Got it</button>\n                </div>\n              </div>\n            );\n          }\n        } catch (e) {}\n        return null;\n      })()}\n      <div className=\"chat-header\" style={{ display: 'flex', alignItems: 'center', justifyContent: 'space-between', gap: 12 }}>\n        <div style={{ display: 'flex', alignItems: 'center', gap: 8 }}>\n          {typeof onBack === 'function' ? (\n            <button aria-label=\"Back to threads\" onClick={() => { try { onBack && onBack(); } catch (e) {} }} style={{ marginRight: 6 }} className=\"prompt-btn\">←</button>\n          ) : null}\n          <h3 style={{ margin: 0, flex: '0 1 auto' }}>{activeThread?.title ?? \"Thinking space\"}</h3>\n        </div>\n        {typeof onOpenRight === 'function' ? (\n          <button className=\"mobile-hamburger\" aria-label=\"Toggle summary\" onClick={() => onOpenRight()} style={{ marginLeft: 'auto' }}>\n            ☰\n          </button>\n        ) : null}\n      </div>\n\n      <div className=\"messages\" aria-live=\"polite\" ref={messagesRef}>\n        {messages.map((m) => (\n          <div key={m.id} className={`msg ${m.role}`}>\n            <div className=\"msg-meta\" style={{ fontSize: 12, color: \"#666\" }}>\n              {m.role}\n              {m.created_at ? ` • ${new Date(m.created_at).toLocaleTimeString()}` : \"\"}\n            </div>\n            <pre style={{ whiteSpace: \"pre-wrap\", margin: 0 }}>{m.content}</pre>\n            {m.streaming && <div style={{ fontSize: 12, color: \"#666\" }}>Streaming…</div>}\n          </div>\n        ))}\n      </div>\n\n      <div className=\"chat-input\" style={{ display: \"flex\", gap: 8, marginTop: 8, alignItems: 'flex-start' }}>\n        <textarea\n          id=\"chat-input\"\n          name=\"chat_input\"\n          aria-label=\"Chat input\"\n          value={input}\n          placeholder=\"Let's untangle this\"\n          ref={inputRef}\n          onChange={(e) => setInput(e.target.value)}\n          onKeyDown={(e) => {\n            if (e.key === \"Enter\" && !e.shiftKey) {\n              e.preventDefault();\n              handleSend();\n            }\n          }}\n          style={{ flex: 1, minHeight: 80 }}\n        />\n        <div style={{ display: \"flex\", flexDirection: \"column\", gap: 8 }}>\n            <button onClick={handleSend} disabled={sending || !input.trim() || userMessageCount >= 5} style={{ minWidth: 100 }}>\n              {sending ? \"Sending…\" : \"Send\"}\n            </button>\n          <button\n            onClick={() => {\n              if (abortRef.current) abortRef.current.abort();\n            }}\n            disabled={!abortRef.current}\n            style={{ minWidth: 100 }}\n          >\n            Cancel\n          </button>\n        </div>\n      </div>\n\n      {/* Signup modal shown after anonymous user reaches limit */}\n      {modalOpen && renderModalContent()}\n\n      {/* Suggestion bar populated from RightPanel summary processing */}\n      {suggestions && suggestions.length > 0 && (\n        <div style={{ marginTop: 8, display: 'flex', gap: 8, flexWrap: 'wrap' }}>\n          {suggestions.map((s, i) => (\n            <button\n              key={i}\n              className=\"suggestion-chip\"\n              onClick={() => {\n                  // insert suggestion at the current caret position (or append) and focus\n                  const area = inputRef.current;\n                  if (!area) {\n                    setInput(s);\n                  } else {\n                    const start = area.selectionStart ?? area.value.length;\n                    const end = area.selectionEnd ?? start;\n                    const before = area.value.slice(0, start);\n                    const after = area.value.slice(end);\n                    const nextVal = (before + s + after).trimStart();\n                    setInput(nextVal);\n                    // set caret right after inserted suggestion\n                    setTimeout(() => {\n                      area.focus();\n                      const caret = (before + s).length;\n                      area.setSelectionRange(caret, caret);\n                    }, 0);\n                  }\n                }}\n              style={{ padding: '6px 10px', borderRadius: 6 }}\n            >\n              {s}\n            </button>\n          ))}\n        </div>\n      )}\n\n      {/* debug UI removed */}\n\n      <div style={{ marginTop: 8 }}>\n        <button\n          className=\"prompt-btn\"\n          onClick={async () => {\n            if (!activeThread) return;\n            if (!window.confirm(\"Delete this chat history for the selected thread?\")) return;\n            const userId = localStorage.getItem(\"user_id\") || \"u1\";\n            try {\n              const resp = await fetch(`${API_BASE}/messages/${encodeURIComponent(userId)}/${encodeURIComponent(activeThread.thread_id)}`, {\n                method: \"DELETE\",\n                headers: { \"Content-Type\": \"application/json\", ...(getAuthHeader()) },\n                credentials: 'include',\n              });\n              if (!resp.ok) {\n                const body = await resp.text().catch(() => \"\");\n                window.dispatchEvent(new CustomEvent('ai_toast', { detail: { message: `Failed to delete chat: ${resp.status} ${body}`, kind: 'error' } }));\n                return;\n              }\n              setMessages([]);\n              window.dispatchEvent(new CustomEvent('ai_toast', { detail: { message: 'Chat history deleted.', kind: 'success' } }));\n            } catch (e) {\n              window.dispatchEvent(new CustomEvent('ai_toast', { detail: { message: `Delete failed: ${String(e)}`, kind: 'error' } }));\n            }\n          }}\n        >\n          Delete Chat\n        </button>\n      </div>\n    </div>\n  );\n}\n\nfunction getFakeResponse(input: string, preferences?: UserPreferences): string {\n  if (!preferences) return \"I’m here to listen.\";\n  if ((preferences as any).default_tone === \"direct\") {\n    return \"Let’s simplify this. What decision are you actually trying to make?\";\n  }\n  if ((preferences as any).depth_level === \"deep\") {\n    return \"Let me reflect this back. It sounds like you’re torn between safety and growth. What’s driving that tension right now?\";\n  }\n  return \"I’m hearing a few competing thoughts here. Want to slow down and look at them one by one?\";\n}\n\n"],"mappings":"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","ignoreList":[]},"metadata":{},"sourceType":"module","externalDependencies":[]}